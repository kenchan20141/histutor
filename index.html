

<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>史萊姆教室</title>

    <!-- 添加到主畫面設定 -->
    <meta name="application-name" content="史萊姆教室">
    <meta name="apple-mobile-web-app-title" content="史萊姆教室">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.ibb.co/WL5vTL9/image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- Android 圖示 -->
    <link rel="icon" sizes="192x192" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="icon" sizes="144x144" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="icon" sizes="96x96" href="https://i.ibb.co/WL5vTL9/image.png">
    <!-- iOS 圖示 -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://i.ibb.co/WL5vTL9/image.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://i.ibb.co/WL5vTL9/image.png">


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
        
    <style>
        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --secondary: #50c878;
            --user-bg: #e6f0fa;
            --user-border: #4a90e2;
            --ai-bg: #f0f4f8;
            --ai-border: #d1e0e8;
            --error-bg: #ffe6e6;
            --error-border: #e57373;
            --recording-bg: #e74c3c;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            --radius: 20px;
            --radius-sm: 12px;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --active-orange: #FF8C00;
            --hunger-red: #FF4444;
            --hunger-yellow: #FFB84D;
            --hunger-green: #4CAF50;
            --personality-purple: #9C27B0;
            --personality-blue: #2196F3;
            --personality-green: #4CAF50;
            --personality-orange: #FF9800;
            --personality-red: #F44336;
            --personality-pink: #E91E63;
            --mysterybox-bronze: #CD7F32;
            --mysterybox-silver: #C0C0C0;
            --mysterybox-gold: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif TC', 'cwTeXHei', 'cwTeXFangSong', 'cwTeXKai', 'cwTeXMing', 'PingFang TC', 'Microsoft JhengHei', serif;
            background-image: url('https://i.ibb.co/PvJfB2CW/image.png');
            background-size: cover;
            background-position: center;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 25px;
            padding-top: 100px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .copyright-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 5px 10px;
            background-color: #f1f1f1;
            z-index: 1;
        }

        .copyright-footer p {
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 600px) {
            .copyright-footer p {
                font-size: 12px;
            }
        }
        
        /* 頂部控制區域 */
        .top-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(169, 204, 227  , 0.85);
            backdrop-filter: blur(10px);
            z-index: 102;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .shop-button, .settings-button {
            background: linear-gradient(135deg, var(--gold), var(--silver));
            color: white;
            padding: 12px 18px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
        }

        .settings-button {
            background: #abb2b9 ;
            padding: 12px 15px;
            width: 40px;
        }

        /* 移動端適配 */
    @media (max-width: 768px) {
        /* 設置按鈕使用自動寬度 */
        .settings-button {
            flex: 0 0 auto !important; /* 禁止伸縮 */
            padding: 8px 10px !important; /* 進一步減少內邊距 */
            min-width: unset !important; /* 移除最小寬度限制 */
        }
        

@media (max-width: 768px) {
    .received-gift-item {
        min-width: 0; /* 移除固定最小寬度，讓其適應容器 */
        width: 100%; /* 確保佔滿可用寬度 */
        flex-direction: row; /* 改回水平佈局，避免過度堆疊 */
        flex-wrap: wrap; /* 允許換行 */
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px; /* 減小內邊距以適應小屏幕 */
        box-sizing: border-box; /* 確保邊框和內邊距不超出 */
    }
}

.received-gift-item > div:first-child {
    min-width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.received-gift-item .item-preview {
    margin-right: 0;
    margin-bottom: 10px;
}



       
    }

        .shop-button:hover, .settings-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .shop-button .points {
            background: rgba(255, 255, 255, 0.3);
            padding: 3px 10px;
            border-radius: 15px;
        }

        .hunger-bar-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
        }

        .hunger-icon {
            font-size: 1.2rem;
            color: var(--hunger-green);
        }

        .hunger-icon.hungry {
            color: var(--hunger-yellow);
        }

        .hunger-icon.very-hungry {
            color: var(--hunger-red);
        }

        .hunger-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .hunger-fill {
            height: 100%;
            background: var(--hunger-green);
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .hunger-fill.hungry {
            background: var(--hunger-yellow);
        }

        .hunger-fill.very-hungry {
            background: var(--hunger-red);
        }

        .hunger-percentage {
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        #chat-container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 160px);
            position: relative;
            z-index: 10;
        }

        #chat-header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #chat-header i {
            font-size: 1.8rem;
        }

        #chat-header h2 {
            font-weight: 700;
            font-size: 1.6rem;
            flex-grow: 1;
        }

        #mode-select {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            background: white;
            color: var(--text-dark);
            border: none;
            cursor: pointer;
        }

        #chat-output {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: #f7fafc;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .message {
            max-width: 80%;
            padding: 18px 24px;
            border-radius: var(--radius-sm);
            position: relative;
            box-shadow: var(--shadow);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .user-message {
            background: var(--user-bg);
            border-left: 5px solid var(--user-border);
            align-self: flex-end;
        }

        .ai-message {
            background: var(--ai-bg);
            border-left: 5px solid var(--ai-border);
            align-self: flex-start;
        }

        .error-message {
            background: var(--error-bg);
            border-left: 5px solid var(--error-border);
            align-self: center;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .user-message .message-header {
            color: var(--primary-dark);
        }

        .ai-message .message-header {
            color: var(--secondary);
        }

        .message-content {
            line-height: 1.7;
            font-size: 1.05rem;
        }

        .message-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 10px;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: white;
            color: var(--primary);
        }

        .copy-btn.copied {
            color: var(--secondary);
            transform: scale(1.15);
        }

        .copy-btn.copied i::before {
            content: "\f00c";
        }

        #input-container {
            display: flex;
            padding: 20px 25px;
            background: white;
            border-top: 1px solid #edf2f7;
            gap: 15px;
            align-items: center;
            position: relative;
            flex-wrap: wrap;
        }

        #user-input {
            flex: 1;
            min-width: 200px;
            padding: 18px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #user-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(74, 144, 226, 0.3);
        }

        #voice-btn, #send-btn {
            padding: 0 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            height: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s, transform 0.2s;
            min-width: 50px;
            flex-shrink: 0;
        }

        #send-btn {
            background: #45b39d;
        }

        #voice-btn:hover {
            background: #a3bffa;
            transform: translateY(-2px);
        }

        #send-btn:hover {
            background: #45b39d;
            transform: translateY(-2px);
        }

        #voice-btn:disabled {
            background: #a3bffa;
            cursor: not-allowed;
            transform: none;
        }

        #send-btn:disabled {
            background: #45b39d;
            cursor: not-allowed;
            transform: none;
        }

        #voice-btn.recording {
            background: var(--recording-bg);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #tts-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-dark);
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: var(--ai-bg);
            border-radius: var(--radius-sm);
            align-self: flex-start;
            box-shadow: var(--shadow);
        }

        .typing-indicator span {
            height: 12px;
            width: 12px;
            background: var(--text-light);
            border-radius: 50%;
            display: inline-block;
            margin: 0 3px;
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .recording-indicator {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--recording-bg);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideDown {
            from { top: -60px; opacity: 0; }
            to { top: -40px; opacity: 1; }
        }

        .recording-indicator i {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .swipe-hint {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: none;
        }

        /* VTUBER 頭像相關樣式 */
        .vtuber-container {
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            border: 3px solid var(--primary);
            transition: all 0.3s ease;
            cursor: grab;
            user-select: none;
        }

        .vtuber-container:active {
            cursor: grabbing;
        }

        .vtuber-avatar {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .vtuber-face {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #fde2e4;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .vtuber-face.hungry {
            background: #e8d5d6;
            transform: scale(0.95);
        }

        .vtuber-face.very-hungry {
            background: #dcc5c6;
            transform: scale(0.9);
        }

        .vtuber-hair {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        }

        .vtuber-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 25px;
            display: flex;
            justify-content: space-between;
            z-index: 3;
        }

        .vtuber-face.hungry .vtuber-eyes {
            opacity: 0.8;
            transform: translate(-50%, -50%) scale(0.9);
        }

        .vtuber-face.very-hungry .vtuber-eyes {
            opacity: 0.6;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .vtuber-eye {
            width: 30px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vtuber-face.hungry .vtuber-eye {
            transform: scaleY(0.8);
        }

        .vtuber-face.very-hungry .vtuber-eye {
            transform: scaleY(0.6);
        }

        .vtuber-pupil {
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            animation: blink 4s infinite;
        }

        .vtuber-mouth {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 15px;
            background: #ff9aa2;
            border-radius: 0 0 20px 20px;
            transition: all 0.2s ease;
            overflow: hidden;
            z-index: 3;
        }

        .vtuber-face.hungry .vtuber-mouth {
            width: 35px;
            height: 12px;
            background: #e08a8a;
        }

        .vtuber-face.very-hungry .vtuber-mouth {
            width: 30px;
            height: 10px;
            background: #cc7a7a;
            border-radius: 50%;
        }

        .vtuber-mouth.talking {
            animation: talking 0.3s infinite alternate;
        }

        .vtuber-face.hungry .vtuber-mouth.talking {
            animation: hungryTalking 0.4s infinite alternate;
        }

        .vtuber-face.very-hungry .vtuber-mouth.talking {
            animation: veryHungryTalking 0.5s infinite alternate;
        }

        .vtuber-mouth.eating {
            animation: eating 0.5s ease-in-out 3;
            background: #ffb347;
        }

        .vtuber-mouth-inner {
            width: 100%;
            height: 10px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        }

        @keyframes talking {
            from { height: 15px; }
            to { height: 20px; }
        }

        @keyframes hungryTalking {
            from { height: 12px; }
            to { height: 16px; }
        }

        @keyframes veryHungryTalking {
            from { height: 10px; }
            to { height: 13px; }
        }

        @keyframes eating {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }

        @keyframes blink {
            0%, 5%, 15%, 100% { transform: scaleY(1); }
            10% { transform: scaleY(0.1); }
        }

        /* 商店和設置彈窗樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .points-display {
            font-size: 1.4rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--gold), var(--silver));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .points-display i {
            color: var(--gold);
        }

        .shop-tabs, .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            border: none;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .shop-item {
    background: #f9f9f9;
    border-radius: var(--radius-sm);
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid #e2e8f0;
    position: relative;
}

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .shop-item.owned {
            border-color: var(--secondary);
        }

        .item-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            position: relative;
            overflow: hidden;
        }

        .expression-preview {
            background: #fde2e4;
            border-radius: 50%;
        }

        .food-preview {
            background: #fff3cd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .personality-preview {
            background: linear-gradient(135deg, var(--personality-purple), var(--personality-blue));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        /* 新增盲盒預覽樣式 */
        .mysterybox-preview {
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            background-size: cover;
            background-position: center;
        }

        .mysterybox-bronze {
            background: linear-gradient(135deg, var(--mysterybox-bronze), #A57044);
        }

        .mysterybox-silver {
            background: linear-gradient(135deg, var(--mysterybox-silver), #A8A9AD);
        }

        .mysterybox-gold {
            background: linear-gradient(135deg, var(--mysterybox-gold), #E5C100);
        }

        .expression-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        }

        .expression-eye {
            width: 20px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            position: relative;
        }

        .expression-pupil {
            width: 8px;
            height: 8px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 6px;
        }

        .expression-mouth {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        }

        .expression-mouth-inner {
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        }

        /* 髮型樣式 */
        .hair-1 {
            background: #8B4513;
            clip-path: polygon(0 0, 100% 0, 80% 50%, 20% 50%);
            height: 35px;
        }

        .hair-2 {
            background: #FFD700;
            clip-path: polygon(0 0, 100% 0, 90% 40%, 60% 50%, 30% 40%);
            height: 40px;
        }

        .hair-3 {
            background: #FF4500;
            clip-path: polygon(0 0, 100% 0, 70% 60%, 30% 60%);
            height: 35px;
        }

        .hair-4 {
            background: #4682B4;
            clip-path: polygon(0 0, 100% 0, 85% 30%, 50% 50%, 15% 30%);
            height: 30px;
        }

        .hair-5 {
            background: #228B22;
            clip-path: polygon(0 0, 100% 0, 95% 45%, 70% 55%, 30% 55%, 5% 45%);
            height: 40px;
        }

        .hair-6 {
            background: #9932CC;
            clip-path: polygon(0 0, 100% 0, 80% 40%, 60% 60%, 40% 60%, 20% 40%);
            height: 45px;
        }

        .shop-item h3 {
            margin: 10px 0;
            font-size: 1rem;
            color: var(--text-dark);
        }

        .shop-item .price {
            font-size: 0.9rem;
            color: var(--gold);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .shop-btn {
            padding: 6px 12px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            font-size: 0.9rem;
        }

        .buy-btn {
            background: var(--primary);
            color: white;
        }

        .buy-btn:hover {
            background: var(--primary-dark);
        }

        .buy-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .use-btn {
            background: var(--secondary);
            color: white;
        }

        .use-btn:hover {
            background: #3daa65;
        }

        .shop-item.owned .use-btn {
            background: var(--secondary);
        }

        .shop-item.owned .use-btn.active {
            background: var(--active-orange);
        }

        /* 設置界面樣式 */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.3rem;
        }

        .name-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .name-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .name-input:focus {
            border-color: var(--primary);
        }

        .name-save-btn {
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .name-save-btn:hover {
            background: #3daa65;
        }

        .name-save-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .current-name-display {
            margin-top: 10px;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 8px;
            color: var(--text-dark);
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }

        .error-message-input {
            background: #ffe6e6;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #e57373;
        }



/* 隱藏版表情樣式 */
.hidden-sleepy .expression-mouth,
.vtuber-face.hidden-sleepy .vtuber-mouth {
    width: 20px;
    height: 8px;
    background: #8B8B8B;
    border-radius: 50%;
    transform: translateX(-50%);
    animation: sleepyBreath 3s ease-in-out infinite;
}

.hidden-sleepy .expression-eyes,
.vtuber-face.hidden-sleepy .vtuber-eyes {
    transform: translate(-50%, -50%) scale(1.1);
}

.hidden-sleepy .expression-eye,
.vtuber-face.hidden-sleepy .vtuber-eye {
    height: 6px;
    background: #8B8B8B;
    transform: scaleY(0.3);
    border-radius: 10px;
    position: relative;
}

.hidden-sleepy .expression-eye::before,
.vtuber-face.hidden-sleepy .vtuber-eye::before {
    content: '';
    position: absolute;
    top: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #333;
    border-radius: 50% 50% 0 0;
}
.hidden-sleepy .expression-pupil,
.vtuber-face.hidden-sleepy .vtuber-pupil {
    display: none;
}

.hidden-sleepy::after,
.vtuber-face.hidden-sleepy::after {
    content: 'Zzz...';
    position: absolute;
    top: -25px;
    right: 10px;
    font-size: 16px;
    color: #666;
    animation: sleepFloating 2s ease-in-out infinite alternate;
    font-style: italic;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

@keyframes sleepyBreath {
    0%, 100% { 
        width: 20px; 
        height: 8px; 
        opacity: 0.8;
    }
    50% { 
        width: 25px; 
        height: 10px; 
        opacity: 1;
    }
}

@keyframes sleepFloating {
    from { 
        opacity: 0.3; 
        transform: translateY(0px) scale(0.8); 
    }
    to { 
        opacity: 0.8; 
        transform: translateY(-8px) scale(1.1); 
    }
}
.hidden-shock-eyes .expression-eyes,
.vtuber-face.hidden-shock-eyes .vtuber-eyes {
    transform: translate(-50%, -50%) scale(1.8);
}

.hidden-shock-eyes .expression-eye,
.vtuber-face.hidden-shock-eyes .vtuber-eye {
    transform: scale(1.2);
    background: #FFFFFF;
    border: 3px solid #FF0000;
}

.hidden-shock-eyes .expression-pupil,
.vtuber-face.hidden-shock-eyes .vtuber-pupil {
    transform: scale(0.5);
    background: #000;
}

.hidden-shock-eyes .expression-mouth,
.vtuber-face.hidden-shock-eyes .vtuber-mouth {
    width: 8px;
    height: 25px;
    border-radius: 50%;
    background: #000;
    transform: translateX(-50%);
}

.hidden-shock-eyes::after,
.vtuber-face.hidden-shock-eyes::after {
    content: "⚡⚡⚡";
    position: absolute;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    animation: lightning 0.5s infinite alternate;
}

@keyframes lightning {
    from { opacity: 1; transform: translateX(-50%) scale(1); }
    to { opacity: 0.5; transform: translateX(-50%) scale(1.2); }
}

.hidden-cold .expression-eyes,
.vtuber-face.hidden-cold .vtuber-eyes {
    transform: translate(-50%, -50%) rotate(-5deg) scaleY(0.8);
}

.hidden-cold .expression-mouth,
.vtuber-face.hidden-cold .vtuber-mouth {
    width: 25px;
    height: 5px;
    background: #4682B4;
    border-radius: 0;
}

/* 隱藏版髮型樣式 */
/* 隱藏版髮型樣式 */
.hidden-hair-1 {
    background: linear-gradient(45deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3);
    background-size: 200% 200%;
    animation: rainbowFlow 2s ease-in-out infinite;
    clip-path: polygon(0 0, 100% 0, 95% 60%, 5% 60%);
    height: 45px;
    position: relative;
    overflow: hidden;
}

.hidden-hair-1::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 1.5s infinite;
}

@keyframes rainbowFlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.hidden-hair-2 {
    background: radial-gradient(circle at 30% 30%, #000033, #000066, #003366, #006699, #0099CC);
    clip-path: polygon(0 0, 100% 0, 90% 35%, 75% 55%, 25% 55%, 10% 35%);
    height: 40px;
    position: relative;
    overflow: hidden;
}

.hidden-hair-2::before {
    content: '✨';
    position: absolute;
    top: 8px;
    left: 20%;
    font-size: 12px;
    color: white;
    animation: twinkle 2s infinite alternate;
}

.hidden-hair-2::after {
    content: '⭐';
    position: absolute;
    top: 15px;
    right: 25%;
    font-size: 10px;
    color: #FFD700;
    animation: twinkle 1.5s infinite alternate-reverse;
}

@keyframes twinkle {
    from { opacity: 0.3; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1.2); }
}

.hidden-hair-3 {
    background: linear-gradient(135deg, #FF00FF, #00FFFF, #FFFF00, #FF69B4, #7B68EE, #00FA9A);
    background-size: 300% 300%;
    animation: auroraFlow 3s ease-in-out infinite;
    clip-path: polygon(0 0, 100% 0, 95% 30%, 80% 50%, 20% 50%, 5% 30%);
    height: 42px;
    position: relative;
    filter: blur(0.5px);
}

.hidden-hair-3::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
    animation: auroraShine 2s infinite;
}

@keyframes auroraFlow {
    0% { background-position: 0% 0%; filter: hue-rotate(0deg); }
    25% { background-position: 100% 100%; filter: hue-rotate(90deg); }
    50% { background-position: 0% 100%; filter: hue-rotate(180deg); }
    75% { background-position: 100% 0%; filter: hue-rotate(270deg); }
    100% { background-position: 0% 0%; filter: hue-rotate(360deg); }
}

@keyframes auroraShine {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
}

/* 隱藏版性格樣式 */
.personality-hidden-wuxia {
    background: linear-gradient(135deg, #8B0000, #4B0082);
}

.personality-hidden-poet {
    background: linear-gradient(135deg, #4682B4, #87CEEB);
}

.personality-hidden-sage {
    background: linear-gradient(135deg, #DAA520, #D2B48C);
}

/* 隱藏商品樣式 */
.hidden-item-preview {
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.shop-item.hidden-item .item-preview::after {
    content: '?';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2.5rem;
    color: white;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}

.shop-item.hidden-item .item-preview {
    background: linear-gradient(135deg, #8a2be2, #4b0082);
}




        /* 表情樣式 */
        .happy .expression-mouth {
            border-radius: 50%;
            height: 20px;
            width: 30px;
            bottom: 20px;
        }
        
        .vtuber-face.happy .vtuber-mouth {
            border-radius: 50%;
            height: 25px;
            width: 35px;
            bottom: 25px;
        }

        .angry .expression-eyes {
            transform: translate(-50%, -50%) rotate(10deg);
        }
        
        .angry::before {
            content: "💢";
            position: absolute;
            top: 0;
            right: 0;
            font-size: 20px;
        }
        
        .vtuber-face.angry::before {
            content: "💢";
            position: absolute;
            top: 0;
            right: 0;
            font-size: 28px;
        }

        .angry .expression-mouth {
            border-radius: 50%;
            height: 6px;
            width: 35px;
            background: #d9534f;
        }
        
        .vtuber-face.angry .vtuber-mouth {
            height: 8px;
            width: 40px;
            background: #d9534f;
            border-radius: 50%;
        }
        
        .angry .expression-eye,
        .vtuber-face.angry .vtuber-eye {
            transform: rotate(10deg) scaleX(0.8);
        }

        .surprised .expression-eyes {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .surprised .expression-pupil {
            transform: scale(0.8);
        }

        .surprised .expression-mouth {
            border-radius: 50%;
            height: 20px;
            width: 15px;
        }
        
        .vtuber-face.surprised .vtuber-eyes {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .vtuber-face.surprised .vtuber-pupil {
            transform: scale(0.8);
        }
        
        .vtuber-face.surprised .vtuber-mouth {
            border-radius: 50%;
            height: 25px;
            width: 20px;
        }

        .sad .expression-eyes {
            transform: translate(-50%, -30%) rotate(-5deg);
        }

        .sad .expression-mouth {
            border-radius: 50% 50% 0 0;
            height: 8px;
            width: 25px;
            top: 50px;
            background: #5bc0de;
        }
        
        .vtuber-face.sad .vtuber-eyes {
            transform: translate(-50%, -30%) rotate(-5deg);
        }
        
        .vtuber-face.sad .vtuber-mouth {
            border-radius: 50% 50% 0 0;
            height: 10px;
            width: 30px;
            top: 60px;
            bottom: unset;
            background: #5bc0de;
        }

        .wink .expression-eye:first-child {
            height: 3px;
        }

        .wink .expression-eye:first-child .expression-pupil {
            display: none;
        }

        .wink .expression-mouth {
            transform: translateX(-50%) rotate(5deg);
            border-radius: 15px;
            height: 8px;
            width: 30px;
        }
        
        .vtuber-face.wink .vtuber-eye:first-child {
            height: 5px;
        }
        
        .vtuber-face.wink .vtuber-eye:first-child .vtuber-pupil {
            display: none;
        }
        
        .vtuber-face.wink .vtuber-mouth {
            transform: translateX(-50%) rotate(5deg);
            border-radius: 20px;
            height: 10px;
            width: 35px;
        }

        /* 性格系統樣式 */
        .personality-gentle {
            background: linear-gradient(135deg, #FFB6C1, #FFC0CB);
        }

        .personality-serious {
            background: linear-gradient(135deg, #708090, #2F4F4F);
        }

        .personality-cheerful {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .personality-sarcastic {
            background: linear-gradient(135deg, #800080, #4B0082);
        }

        .personality-wise {
            background: linear-gradient(135deg, #20B2AA, #008B8B);
        }

        .personality-humorous {
            background: linear-gradient(135deg, #FF6347, #FF4500);
        }

        /* 盲盒動畫相關樣式 */
/* 3D立體盲盒動畫樣式 */
.mysterybox-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 300;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.mysterybox-3d-container {
    position: relative;
    perspective: 1000px;
    transform-style: preserve-3d;
}

.gift-box-3d {
    width: 200px;
    height: 200px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(-10deg) rotateY(15deg);
    animation: mysteryboxFloat 3s ease-in-out infinite;
}

@keyframes mysteryboxFloat {
    0%, 100% { 
        transform: rotateX(-10deg) rotateY(15deg) translateY(0px); 
    }
    50% { 
        transform: rotateX(-5deg) rotateY(25deg) translateY(-15px); 
    }
}

@keyframes mysteryboxShake {
    0%, 100% { 
        transform: rotateX(-10deg) rotateY(15deg) translateY(0px); 
    }
    25% { 
        transform: rotateX(-8deg) rotateY(12deg) translateY(-5px) translateX(-8px); 
    }
    50% { 
        transform: rotateX(-12deg) rotateY(18deg) translateY(-3px) translateX(8px); 
    }
    75% { 
        transform: rotateX(-6deg) rotateY(20deg) translateY(-8px) translateX(-5px); 
    }
}

/* 盒子消失動畫 */
@keyframes mysteryboxDisappear {
    0% { 
        opacity: 1; 
        transform: scale(1) rotateY(0deg); 
    }
    100% { 
        opacity: 0; 
        transform: scale(0.5) rotateY(180deg); 
    }
}

/* 結果容器放大動畫 */
.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-30px) scale(1.1);
    animation: resultEntrance 0.8s ease-out;
}

@keyframes resultEntrance {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(20px) scale(0.8);
    }
    50% {
        transform: translateX(-50%) translateY(-40px) scale(1.15);
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(-30px) scale(1.1);
    }
}





/* 禮物盒各個面 */
.box-face {
    position: absolute;
    width: 200px;
    height: 200px;
    opacity: 0.95;
    border: 3px solid #8B4513;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
}

.box-front {
    background: linear-gradient(135deg, #FF6B9D 0%, #C44CAE 50%, #8A2BE2 100%);
    transform: translateZ(100px);
}

.box-back {
    background: linear-gradient(135deg, #E55A87 0%, #B23A8E 50%, #7B1FA2 100%);
    transform: translateZ(-100px) rotateY(180deg);
}

.box-right {
    background: linear-gradient(135deg, #FF8E9B 0%, #D147AA 50%, #9C27B0 100%);
    transform: rotateY(90deg) translateZ(100px);
}

.box-left {
    background: linear-gradient(135deg, #E84393 0%, #B8459E 50%, #8E24AA 100%);
    transform: rotateY(-90deg) translateZ(100px);
}

.box-top {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
    transform: rotateX(90deg) translateZ(100px);
    transform-origin: center center;
    transition: all 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.box-bottom {
    background: linear-gradient(135deg, #FF69B4 0%, #DA70D6 50%, #BA55D3 100%);
    transform: rotateX(-90deg) translateZ(100px);
}

/* 盒蓋打開動畫 */
.gift-box-3d.opening .box-top {
    transform: rotateX(90deg) translateZ(100px) rotateX(-120deg) translateY(-80px);
}

/* 禮物盒裝飾絲帶 */
.ribbon-vertical {
    position: absolute;
    width: 20px;
    height: 200px;
    background: linear-gradient(90deg, #DC143C 0%, #B71C1C 50%, #8B0000 100%);
    left: 50%;
    top: 0;
    transform: translateX(-50%);
    z-index: 5;
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.5);
}

.ribbon-horizontal {
    position: absolute;
    width: 200px;
    height: 20px;
    background: linear-gradient(90deg, #DC143C 0%, #B71C1C 50%, #8B0000 100%);
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 5;
    box-shadow: 0 0 15px rgba(220, 20, 60, 0.5);
}

/* 蝴蝶結 */
.bow-3d {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 40px;
    z-index: 6;
}

.bow-left, .bow-right {
    position: absolute;
    width: 25px;
    height: 35px;
    background: linear-gradient(135deg, #FF0000, #CC0000);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
}

.bow-left {
    left: 5px;
    transform: rotate(-25deg);
}

.bow-right {
    right: 5px;
    transform: rotate(25deg);
}

.bow-center {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 15px;
    height: 30px;
    background: linear-gradient(90deg, #B71C1C, #FF0000, #B71C1C);
    border-radius: 3px;
    box-shadow: inset 2px 0 0 rgba(255,255,255,0.3), inset -2px 0 0 rgba(0,0,0,0.3);
}

/* 抽獎結果顯示 */
.mysterybox-result-container {
    position: absolute;
    bottom: -120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 3px solid #FFD700;
    min-width: 300px;
    opacity: 0;
    transition: all 0.8s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-30px);
}

.mysterybox-result-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    display: block;
    animation: resultPulse 2s infinite alternate;
    margin-left: auto;
    margin-right: auto;
}

.mysterybox-result-text {
    font-size: 1.4rem;
    font-weight: bold;
    color: #333;
    margin: 0;
    text-align: center;
    line-height: 1.5;
    text-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

@keyframes resultPulse {
    0% { transform: scale(1) rotate(0deg); }
    100% { transform: scale(1.15) rotate(5deg); }
}

/* 3D紙屑粒子效果 */
.confetti-3d {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: confetti3dFall 4s ease-out forwards;
    z-index: 10;
}

@keyframes confetti3dFall {
    0% {
        transform: translateY(-100vh) rotateX(0deg) rotateZ(0deg) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateY(-50vh) rotateX(180deg) rotateZ(180deg) scale(1.2);
        opacity: 0.8;
    }
    100% {
        transform: translateY(100vh) rotateX(360deg) rotateZ(360deg) scale(0.5);
        opacity: 0;
    }
}

/* 盲盒類型特定顏色 */
.mysterybox-bronze .box-front { background: linear-gradient(135deg, #CD7F32 0%, #A0522D 50%, #8B4513 100%); }
.mysterybox-bronze .box-back { background: linear-gradient(135deg, #B8722D 0%, #965C2A 50%, #7A4513 100%); }
.mysterybox-bronze .box-right { background: linear-gradient(135deg, #D4863A 0%, #A85F2E 50%, #8F4A15 100%); }
.mysterybox-bronze .box-left { background: linear-gradient(135deg, #C27A30 0%, #9E572B 50%, #854315 100%); }
.mysterybox-bronze .box-bottom { background: linear-gradient(135deg, #CE8033 0%, #A45A2C 50%, #8A4614 100%); }

.mysterybox-silver .box-front { background: linear-gradient(135deg, #C0C0C0 0%, #A8A9AD 50%, #708090 100%); }
.mysterybox-silver .box-back { background: linear-gradient(135deg, #B5B5B5 0%, #9D9EA2 50%, #6B7280 100%); }
.mysterybox-silver .box-right { background: linear-gradient(135deg, #CACACA 0%, #B2B3B7 50%, #757C8A 100%); }
.mysterybox-silver .box-left { background: linear-gradient(135deg, #BABABA 0%, #A2A3A7 50%, #6F7685 100%); }
.mysterybox-silver .box-bottom { background: linear-gradient(135deg, #C5C5C5 0%, #ACADB1 50%, #737A88 100%); }

.mysterybox-gold .box-front { background: linear-gradient(135deg, #FFD700 0%, #DAA520 50%, #B8860B 100%); }
.mysterybox-gold .box-back { background: linear-gradient(135deg, #F5D12D 0%, #CF9F1F 50%, #AD800A 100%); }
.mysterybox-gold .box-right { background: linear-gradient(135deg, #FFDC33 0%, #DFA823 50%, #BD890C 100%); }
.mysterybox-gold .box-left { background: linear-gradient(135deg, #FFD11A 0%, #D4A221 50%, #B2830A 100%); }
.mysterybox-gold .box-bottom { background: linear-gradient(135deg, #FFD926 0%, #D9A522 50%, #B7860B 100%); }


.mysterybox-canvas-container {
    position: relative;
    text-align: center;
}

#mysteryboxCanvas {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.mysterybox-result-container {
    position: absolute;
    bottom: -120px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 3px solid #FFD700;
    min-width: 300px;
    opacity: 0;
    transition: all 0.8s ease;
}



.mysterybox-result-container.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-20px);
}

.mysterybox-result-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    display: block;
    animation: resultPulse 2s infinite alternate;
}

.mysterybox-result-text {
    font-size: 1.3rem;
    font-weight: bold;
    color: #333;
    margin: 0;
    text-align: center;
    line-height: 1.4;
}

@keyframes resultPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.1); }
}


       .gift-box {
    width: 200px;
    height: 200px;
    position: relative;
    transform: scale(0);
    animation: appear 0.8s forwards, float 2s 0.8s infinite ease-in-out;
    perspective: 1000px;
    transform-style: preserve-3d;
}

@keyframes appear {
    to { 
        transform: scale(1) rotateY(0deg); 
    }
}

@keyframes float {
    0%, 100% { 
        transform: scale(1) rotateY(0deg) translateY(0px); 
    }
    50% { 
        transform: scale(1.05) rotateY(10deg) translateY(-10px); 
    }
}

.gift-box-top {
    position: absolute;
    top: -30px;
    left: 0;
    width: 200px;
    height: 50px;
    background: linear-gradient(135deg, var(--mysterybox-gold), #B8860B);
    border: 3px solid #8B4513;
    border-radius: 8px 8px 4px 4px;
    z-index: 3;
    transform-origin: bottom center;
    transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 
        0 5px 15px rgba(0,0,0,0.3),
        inset 0 2px 0 rgba(255,255,255,0.3),
        inset 0 -2px 0 rgba(0,0,0,0.2);
    transform-style: preserve-3d;
}

.gift-box-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    border-radius: inherit;
    animation: shine 2s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.gift-box-body {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 200px;
    height: 150px;
    background: linear-gradient(135deg, var(--mysterybox-silver), #A8A9AD);
    border: 3px solid #8B4513;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 
        0 10px 25px rgba(0,0,0,0.4),
        inset 0 3px 0 rgba(255,255,255,0.2),
        inset 0 -3px 0 rgba(0,0,0,0.2);
    transform-style: preserve-3d;
}

.gift-box-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,0.1) 0%, transparent 50%);
}

.gift-box.bronze .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-bronze), #8B4513);
}

.gift-box.bronze .gift-box-body {
    background: linear-gradient(135deg, #CE955B, #A0522D);
}

.gift-box.silver .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-silver), #708090);
}

.gift-box.silver .gift-box-body {
    background: linear-gradient(135deg, #D9D9D9, #A8A9AD);
}

.gift-box.gold .gift-box-top {
    background: linear-gradient(135deg, var(--mysterybox-gold), #DAA520);
}

.gift-box.gold .gift-box-body {
    background: linear-gradient(135deg, #FFE873, #F0E68C);
}

.gift-bow {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 30px;
    z-index: 4;
}

.gift-bow::before, .gift-bow::after {
    content: '';
    position: absolute;
    width: 25px;
    height: 35px;
    background: linear-gradient(135deg, #FF0000, #CC0000);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: 
        0 3px 8px rgba(0,0,0,0.3),
        inset 1px 1px 0 rgba(255,255,255,0.3);
}

.gift-bow::before {
    top: 0;
    left: 0;
    transform: rotate(-25deg);
}

.gift-bow::after {
    top: 0;
    right: 0;
    transform: rotate(25deg);
}

.gift-ribbon {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 15px;
    height: 150px;
    background: linear-gradient(90deg, #CC0000, #FF0000, #CC0000);
    z-index: 2;
    box-shadow: 
        inset 2px 0 0 rgba(255,255,255,0.3),
        inset -2px 0 0 rgba(0,0,0,0.3);
}

.gift-ribbon::before {
    content: '';
    position: absolute;
    top: -30px;
    left: -25px;
    width: 65px;
    height: 15px;
    background: linear-gradient(90deg, #CC0000, #FF0000, #CC0000);
    border-radius: 3px;
    box-shadow: 
        inset 0 2px 0 rgba(255,255,255,0.3),
        inset 0 -2px 0 rgba(0,0,0,0.3);
}

.gift-box.opening .gift-box-top {
    transform: translateY(-80px) rotateX(-120deg) scale(0.9);
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
}

.gift-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, 150%);
    opacity: 0;
    transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 2;
    text-align: center;
}

.gift-box.opened .gift-content {
    transform: translate(-50%, -50%) scale(1.1);
    opacity: 1;
}

.gift-icon {
    font-size: 4.5rem;
    margin-bottom: 20px;
    display: inline-block;
    animation: iconGlow 2s infinite alternate;
    text-shadow: 0 0 20px rgba(255,255,255,0.8);
}

@keyframes iconGlow {
    0% { 
        transform: scale(1) rotate(0deg);
        filter: drop-shadow(0 0 10px rgba(255,215,0,0.8));
    }
    100% { 
        transform: scale(1.1) rotate(5deg);
        filter: drop-shadow(0 0 20px rgba(255,215,0,1));
    }
}

.gift-text {
    color: white;
    font-size: 1.6rem;
    font-weight: bold;
    text-shadow: 
        0 0 10px rgba(0,0,0,0.8),
        0 2px 4px rgba(0,0,0,0.5);
    background: linear-gradient(45deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: textPulse 1.5s infinite alternate;
}

@keyframes textPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); }
}

.confetti {
    position: absolute;
    width: 12px;
    height: 12px;
    opacity: 0;
    border-radius: 50%;
    animation: confetti-3d 4s ease-out forwards;
}

@keyframes confetti-3d {
    0% {
        transform: translateY(-100vh) translateX(0) rotateZ(0deg) scale(1);
        opacity: 1;
    }
    50% {
        transform: translateY(-50vh) translateX(var(--random-x, 0)) rotateZ(180deg) scale(1.2);
        opacity: 0.8;
    }
    100% {
        transform: translateY(100vh) translateX(var(--random-x, 0)) rotateZ(360deg) scale(0.5);
        opacity: 0;
    }
}


        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff0000;
            opacity: 0;
        }

        @keyframes confetti-fall {
            from {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0.3;
            }
        }

        .notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 400;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .notification.show {
            opacity: 1;
        }

        /* 移動端適配 */
       @media (max-width: 768px) {
    body {
        padding: 15px;
        padding-top: 80px;
    }

    .top-controls {
        padding: 10px 15px;
        flex-direction: row;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
    }

    .left-controls {
        flex: 1;
        gap: 8px;
    }

    .shop-button, .settings-button {
        flex: 1;
        padding: 8px 12px;
        font-size: 0.9rem;
    }

    .hunger-bar-container {
        flex: 1;
        min-width: 120px;
        padding: 8px 10px;
    }

    .hunger-icon {
        font-size: 1rem;
    }

    .hunger-percentage {
        font-size: 0.8rem;
    }

    .vtuber-container {
        width: 100px;
        height: 100px;
        bottom: 20px;
        right: 20px;
    }

            .vtuber-face {
                width: 80px;
                height: 80px;
            }

            .vtuber-hair {
                height: 40px;
            }

            .vtuber-eyes {
                width: 60px;
                height: 15px;
            }

            .vtuber-eye {
                width: 20px;
                height: 15px;
            }

            .vtuber-pupil {
                width: 8px;
                height: 8px;
            }

            .vtuber-mouth {
                width: 30px;
                height: 10px;
                bottom: 20px;
            }

            .vtuber-mouth.talking {
                height: 18px;
            }

            #chat-container {
                height: calc(100vh - 120px);
            }

            #input-container {
                padding: 15px;
                gap: 8px;
                flex-wrap: nowrap;
            }

            #user-input {
                min-width: 150px;
                padding: 12px 15px;
                font-size: 1rem;
            }

            #voice-btn, #send-btn {
                padding: 0 12px;
                font-size: 1rem;
                min-width: 45px;
                height: 45px;
            }

            #tts-toggle {
                font-size: 0.95rem;
                margin-top: 8px;
            }

            .shop-items {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .item-preview {
                width: 60px;
                height: 60px;
            }

            .shop-item {
                padding: 10px;
            }

            .shop-item h3 {
                font-size: 0.9rem;
            }

            .shop-item .price {
                font-size: 0.8rem;
            }

            .shop-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }

            .name-input-group {
                flex-direction: column;
            }

            .name-input {
                min-width: 100%;
            }

            .gift-box {
                width: 150px;
                height: 150px;
            }

            .gift-box-top {
                width: 150px;
                height: 40px;
            }

            .gift-box-body {
                width: 150px;
                height: 110px;
            }

            .gift-ribbon {
                left: 70px;
                height: 110px;
            }

            .gift-icon {
                font-size: 3rem;
            }

            .gift-text {
                font-size: 1.2rem;
            }
        }


/* 在現有CSS中添加以下樣式 */

/* 認證界面樣式 */
#auth-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
}

.auth-modal {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: var(--shadow);
    max-width: 400px;
    width: 90%;
}

.auth-content h2 {
    text-align: center;
    color: var(--primary);
    margin-bottom: 30px;
}

.auth-content input {
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    outline: none;
}

.auth-content input:focus {
    border-color: var(--primary);
}

.auth-content button {
    width: 100%;
    padding: 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    cursor: pointer;
    margin: 10px 0;
}

.auth-content button:hover {
    background: var(--primary-dark);
}

.auth-content a {
    color: var(--primary);
    text-decoration: none;
}

/* 好友按鈕樣式 */
.friends-button {
    background: #3498db;
    color: white;
    padding: 12px 15px;
    border-radius: 30px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    border: none;
}

.friends-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.logout-button {
    background: #e74c3c;
    color: white;
    padding: 12px 15px;
    border-radius: 30px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.logout-button:hover {
    background: #c0392b;
}

/* 好友系統樣式 */
.friends-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.friends-tab-content {
    min-height: 300px;
}

.add-friend-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.add-friend-form input {
    flex: 1;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
}

.add-friend-form button {
    padding: 12px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}


/* 送禮界面好友項目懸停效果 */
.gift-modal .friend-item:hover {
    border-color: #ff6b9d !important;
    background-color: #fff5f8 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 157, 0.2);
}

.gift-modal .select-friend-btn:hover {
    background: #357abd !important;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}

.gift-modal .select-friend-btn.active {
    background: #ff6b9d !important;
    color: white !important;
}

.gift-modal .select-friend-btn.active:hover {
    background: #e55a87 !important;
}



.friend-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    margin-bottom: 10px;
}

.friend-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
}

.friend-info {
    flex: 1;
}

.friend-actions {
    display: flex;
    gap: 10px;
}

.friend-actions button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

        #send-friend-request {
    padding: 10px;
    font-size: 1.2rem;
    background: #73c6b6 ;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
}   


}
/* 添加以下新樣式 */
.accept-btn, .reject-btn {
    padding: 8px; /* 減少內邊距以適應圖示 */
    width: 40px; /* 固定寬度 */
    height: 40px; /* 固定高度 */
    display: flex;
    align-items: center;
    justify-content: center;
}
@media (max-width: 768px) {
    .accept-btn, .reject-btn {
        width: 35px; /* 小屏幕調整 */
        height: 35px;
        padding: 6px;
    }
}


.chat-btn {
    background: var(--secondary);
    color: white;
}

.accept-btn {
    background: var(--secondary);
    color: white;
}

.reject-btn {
    background: #e74c3c;
    color: white;
}

/* 在現有CSS中添加 */
.gift-btn {
    background: #ff6b9d;
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

.gift-btn:hover {
    background: #e55a87;
}

.gift-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 300;
    justify-content: center;
    align-items: center;
}

.gift-modal-content {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.gift-items {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.gift-item {
    background: #f9f9f9;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.gift-item:hover {
    border-color: #ff6b9d;
    transform: translateY(-2px);
}

.gift-item.selected {
    border-color: #ff6b9d;
    background: #ffe8f0;
}

.received-gifts {
    background: #e8f5e8;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.received-gift-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #ff6b9d;
    min-width: 0; /* 移除固定最小寬度 */
    width: 100%; /* 適應容器寬度 */
    gap: 15px;
    flex-wrap: wrap; /* 允許換行 */
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    box-sizing: border-box; /* 確保計算正確 */
}

.received-gift-item > div:first-child {
    flex: 1;
    min-width: 0; /* 移除固定最小寬度 */
    width: 100%; /* 適應容器 */
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.received-gift-item .item-preview {
    flex-shrink: 0;
    margin-right: 15px;
}

.received-gift-item button {
    flex-shrink: 0;
    min-width: 80px;
    white-space: nowrap;
}




.gift-notification {
    position: fixed;
    top: 100px;
    right: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 500;
    max-width: 300px;
}

.gift-notification-content {
    padding: 20px;
    text-align: center;
}

.gift-notification-content h3 {
    color: #ff6b9d;
    margin-bottom: 10px;
}

.gift-notification-content button {
    background: #ff6b9d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    margin-top: 10px;
}


.gift-icon {
    color: #ff6b9d;
    font-size: 1rem;
    transition: transform 0.2s ease;
}
.gift-icon:hover {
    transform: scale(1.2);
}


/* 好友選擇按鈕樣式改進 */
#friend-select-list .friend-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    transition: all 0.3s ease;
}

#friend-select-list .friend-item:hover {
    border-color: #ff6b9d;
    background-color: #ffe8f0;
}

#friend-select-list button.active {
    background: #ff6b9d !important;
    color: white !important;
}

#confirm-gift-btn:disabled {
    background: #a0aec0 !important;
    cursor: not-allowed;
}

/* 送禮界面優化樣式 */
.gift-modal-content {
    max-width: 500px;
    width: 95%;
}

#friend-select-list .friend-item {
    transition: all 0.3s ease;
}

#friend-select-list .friend-item:hover {
    border-color: #ff6b9d;
    background-color: #fff5f8;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.select-friend-btn {
    transition: all 0.3s ease;
}

.select-friend-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.select-friend-btn.active {
    background: #ff6b9d !important;
    color: white !important;
}

/* 禮物圖標改進 */
.gift-icon {
    z-index: 5;
    transition: all 0.2s ease;
}

.gift-icon:hover {
    transform: scale(1.3);
    color: #ff6b9d !important;
}

/* 商品項目相對定位確保禮物圖標正確顯示 */
.shop-item {
    position: relative;
}



        /* 垂直滾動軸樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #edf2f7;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
    <!-- 登入界面 -->
    <div id="auth-container" style="display: none;">
        <div class="auth-modal">
            <div class="auth-content">
                <h2>史萊姆教室</h2>
                <div id="login-form">
                    <h3>登入</h3>
                    <input type="email" id="login-email" placeholder="電子郵件">
                    <input type="password" id="login-password" placeholder="密碼">
                    <button id="login-btn">登入</button>
                    <p>還沒有帳號？<a href="#" id="show-register">註冊</a></p>
                </div>
                <div id="register-form" style="display: none;">
                    <h3>註冊</h3>
                    <input type="email" id="register-email" placeholder="電子郵件">
                    <input type="password" id="register-password" placeholder="密碼">
                    <input type="text" id="register-character-name" placeholder="角色名稱">

                    <button id="register-btn">註冊</button>
                    <p>已有帳號？<a href="#" id="show-login">登入</a></p>
                </div>
            </div>
        </div>
    </div>



    <!-- 頂部控制區域 -->
    <div class="top-controls">
        <div class="left-controls">
              <button class="settings-button" id="settings-button">
                <i class="fas fa-cog"></i>
          

<!-- 新增好友按鈕 -->
            <button class="friends-button" id="friends-button">
                <i class="fas fa-users"></i>
            </button>


            </button>
            <button class="shop-button" id="shop-button">
                <i class="fas fa-store"></i>
           
                <span class="points" id="points-display">0 點</span>
            </button>
            
          
        </div>





        <div class="hunger-bar-container" id="hunger-bar-container">
            <i class="fas fa-drumstick-bite hunger-icon" id="hunger-icon"></i>
            <div class="hunger-bar">
                <div class="hunger-fill" id="hunger-fill"></div>
            </div>
            <span class="hunger-percentage" id="hunger-percentage">100%</span>
        </div>

 <!-- 添加登出按鈕 -->
        <button class="logout-button" id="logout-button">
            <i class="fas fa-sign-out-alt"></i>
        </button>

        
    </div>

    <!-- 商店彈窗 -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> 商店</h2>
                <button class="close-modal" id="close-shop">×</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>點數: <span id="shop-points">0</span></span>
            </div>
            <p>與史萊姆聊天可以獲得點數，每完成一輪對話獲得1點</p>
            
            <div class="shop-tabs">
                <button class="tab active" data-tab="expressions">表情</button>
                <button class="tab" data-tab="hairstyles">髮型</button>
                <button class="tab" data-tab="foods">食物</button>
                <button class="tab" data-tab="personalities">形象</button>
                <button class="tab" data-tab="mysteryboxes">盲盒</button>
            </div>
            
            <div class="shop-items" id="shop-items">
                <!-- 商品將通過JS動態生成 -->
            </div>
        </div>
    </div>

<!-- 好友系統彈窗 -->
<div class="modal" id="friends-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-users"></i> 好友系統</h2>
            <button class="close-modal" id="close-friends">×</button>
        </div>
        
        <div class="friends-tabs">
    <button class="tab active" data-tab="friends-list">好友列表</button>
    <button class="tab" data-tab="add-friend">添加好友</button>
    <button class="tab" data-tab="friend-requests">好友申請</button>
</div>
        
        <div id="friends-content">
            <!-- 好友列表 -->
            <div id="friends-list" class="friends-tab-content">
                <div id="friends-list-container"></div>
            </div>
            
            <!-- 添加好友 -->
            <div id="add-friend" class="friends-tab-content" style="display: none;">
                <div class="add-friend-form">
                    <input type="email" id="friend-email" placeholder="輸入好友的電子郵件">
                   <button id="send-friend-request"><i class="fas fa-user-plus"></i></button>

                </div>
            </div>
            
            <!-- 好友申請 -->
            <div id="friend-requests" class="friends-tab-content" style="display: none;">
                <div id="friend-requests-container"></div>
            </div>
            
           
        </div>
    </div>
</div>



    <!-- 設置彈窗 -->
    <div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-cog"></i> 設置</h2>
            <button class="close-modal" id="close-settings">×</button>
        </div>
        
        <div class="settings-section">
            <h3><i class="fas fa-user"></i> 角色名稱設定</h3>
            <div class="name-input-group">
                <input type="text" class="name-input" id="vtuber-name-input" placeholder="輸入自定義名稱" maxlength="20">
                <button class="name-save-btn" id="save-name-btn">保存</button>
            </div>
            <div class="current-name-display" id="current-name-display">
                當前名稱：史萊姆
            </div>
        </div>
        


        <div class="settings-section">
            <h3><i class="fas fa-volume-up"></i> 語音設置</h3>
            <div class="tts-toggle">
                <label for="tts-auto-play">自動播放語音回應</label>
                <input type="checkbox" id="tts-auto-play" checked>
            </div>
        </div>
    </div>
</div>

<!-- 3D立體盲盒動畫容器 -->
<div class="mysterybox-animation" id="mysterybox-animation" style="display: none;">
    <div class="mysterybox-3d-container">
        <div class="gift-box-3d" id="gift-box-3d">
            <!-- 禮物盒六個面 -->
            <div class="box-face box-front"></div>
            <div class="box-face box-back"></div>
            <div class="box-face box-right"></div>
            <div class="box-face box-left"></div>
            <div class="box-face box-top" id="box-top"></div>
            <div class="box-face box-bottom"></div>
            
            <!-- 裝飾絲帶 -->
            <div class="ribbon-vertical"></div>
            <div class="ribbon-horizontal"></div>
            
            <!-- 蝴蝶結 -->
            <div class="bow-3d">
                <div class="bow-left"></div>
                <div class="bow-right"></div>
                <div class="bow-center"></div>
            </div>
        </div>
        
        <!-- 抽獎結果顯示 -->
        <div class="mysterybox-result-container" id="mysterybox-result-container">
            <span class="mysterybox-result-icon" id="mysterybox-result-icon"></span>
            <p class="mysterybox-result-text" id="mysterybox-result-text"></p>
        </div>
    </div>
</div>



    <!-- 通知提示 -->
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i>
        <span id="notification-text"></span>
    </div>

    <!-- VTUBER 動畫顯示區 -->
    <div class="vtuber-container" id="vtuber-container">
        <div class="vtuber-avatar">
            <div class="vtuber-face" id="vtuber-face">
                <div class="vtuber-hair" id="vtuber-hair"></div>
                <div class="vtuber-eyes">
                    <div class="vtuber-eye">
                        <div class="vtuber-pupil"></div>
                    </div>
                    <div class="vtuber-eye">
                        <div class="vtuber-pupil"></div>
                    </div>
                </div>
                <div class="vtuber-mouth" id="vtuber-mouth">
                    <div class="vtuber-mouth-inner"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <i class="fas fa-robot"></i>
            <h2 id="vtuber-display-name">史萊姆</h2>
            <select id="mode-select">
                <option value="comfort">世史模式</option>
                <option value="philosophy">中史模式</option>
            </select>
        </div>

        <div id="chat-output">
            <!-- Initial message will be added via JavaScript -->
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>

       <div id="input-container">
    <input type="text" id="user-input" placeholder="輸入你的訊息..." />
    <button id="voice-btn" title="點擊語音輸入">
        <i class="fas fa-microphone"></i>
    </button>
    <button id="send-btn">
        <i class="fas fa-paper-plane"></i>
    </button>
    <div class="recording-indicator" id="recording-indicator" style="display: none;">
        <i class="fas fa-circle"></i> 正在聆聽...
    </div>
    <div class="swipe-hint" id="swipe-hint">
        滑動取消
    </div>
</div>
    </div>

    <footer class="copyright-footer">
        <p>Copyright © 2025 陳冠健、黃子謙. All rights reserved.</p>
    </footer>

    <script>


// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCNnFDrHrUFCPFNPcAYB2eLV_lMlBI9zB8",
  authDomain: "aiwritingtool-243aa.firebaseapp.com",
  databaseURL: "https://aiwritingtool-243aa-default-rtdb.firebaseio.com",
  projectId: "aiwritingtool-243aa",
  storageBucket: "aiwritingtool-243aa.firebasestorage.app",
  messagingSenderId: "532808111828",
  appId: "1:532808111828:web:74cd1001e232e196598d41"
};

// 初始化 Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// 在現有Firebase初始化後添加
const auth = firebase.auth();
let currentUser = null;
let userProfile = null;
let currentGiftReceiver = null;
let selectedGiftItem = null;


// 添加認證相關變量
const authContainer = document.getElementById('auth-container');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterLink = document.getElementById('show-register');
const showLoginLink = document.getElementById('show-login');
const loginBtn = document.getElementById('login-btn');
const registerBtn = document.getElementById('register-btn');
const logoutBtn = document.getElementById('logout-button');

// 好友系統相關元素
const friendsButton = document.getElementById('friends-button');
const friendsModal = document.getElementById('friends-modal');
const closeFriends = document.getElementById('close-friends');
const friendsTabs = document.querySelectorAll('.friends-tabs .tab');



        const API_KEYS = [
            "sk-gAqOM7J27yElhAN6rE3iEw",
            "sk-04KvBMK1EUyinjzdCb1wXQ"
        ];
        let currentApiKeyIndex = 0;
        const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
        const MODEL = "DeepSeek-R1-0528";

        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const modeSelect = document.getElementById('mode-select');
        const typingIndicator = document.getElementById('typing-indicator');
        const ttsAutoPlay = document.getElementById('tts-auto-play');
        const recordingIndicator = document.getElementById('recording-indicator');
        const swipeHint = document.getElementById('swipe-hint');
        const vtuberMouth = document.getElementById('vtuber-mouth');
        const vtuberContainer = document.getElementById('vtuber-container');
        const vtuberFace = document.getElementById('vtuber-face');
        const vtuberHair = document.getElementById('vtuber-hair');
        const shopButton = document.getElementById('shop-button');
        const shopModal = document.getElementById('shop-modal');
        const closeShop = document.getElementById('close-shop');
        const shopPoints = document.getElementById('shop-points');
        const pointsDisplay = document.getElementById('points-display');
        const shopItems = document.getElementById('shop-items');
        const shopTabs = document.querySelectorAll('.shop-tabs .tab');
        const hungerIcon = document.getElementById('hunger-icon');
        const hungerFill = document.getElementById('hunger-fill');
        const hungerPercentage = document.getElementById('hunger-percentage');
        
        // 盲盒相關元素
        const mysteryboxAnimation = document.getElementById('mysterybox-animation');
        const giftBox = document.getElementById('gift-box');
        const giftContent = document.getElementById('gift-content');
        const giftIcon = document.getElementById('gift-icon');
        const giftText = document.getElementById('gift-text');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // 設置相關元素
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const vtuberNameInput = document.getElementById('vtuber-name-input');
        const saveNameBtn = document.getElementById('save-name-btn');
        const currentNameDisplay = document.getElementById('current-name-display');
        const vtuberDisplayName = document.getElementById('vtuber-display-name');
        
        let conversationHistory = [];
        let isRecording = false;
        let touchStartY, touchStartX;
        const SWIPE_THRESHOLD = 100;
        let recognition;
        let transcript = '';
        let silenceTimeout;
        let isTalking = false;
        let isDragging = false;
        let dragStartTime = 0;
        
        // 粗言穢語過濾器
        const profanityFilter = [
            '屌', '撚', '仆街', '仆你', '撚你', '屌你', '仆佢', '撚佢', '屌佢',
            'diu', 'lan', 'puk', 'dick', 'fuck', 'shit', 'damn', 'hell',
            '媽的', '他媽', '你媽', '幹你', '幹他', '去死', '死人',
            '白痴', '智障', '傻逼', '蠢豬', '廢物', '垃圾人', '賤人',
            '婊子', '妓女', '雞婆', '臭婆', '死女人', '死男人'
        ];
        
        // 檢查是否包含粗言穢語
        function containsProfanity(text) {
            const lowerText = text.toLowerCase();
            return profanityFilter.some(word => lowerText.includes(word.toLowerCase()));
        }
        
        // 文本清理函數 - 移除所有格式符號
        function cleanText(text) {
            if (!text) return text;
            
            return text
                // 移除思考標籤
                .replace(/<think>[\s\S]*?<\/think>/gi, '')
                // 移除所有星號格式
                .replace(/\*{1,3}([^*]+)\*{1,3}/g, '$1')
                // 移除單獨的星號
                .replace(/\*/g, '')
                // 移除斜線格式
                .replace(/\/([^/\s]+)\//g, '$1')
                // 移除單獨的斜線
                .replace(/(?<!\w)\/(?!\w)/g, '')
                // 移除其他格式符號
                .replace(/[`~#\[\]]/g, '')
                // 移除多餘的空格和換行
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // 表情、髮型、食物和性格商店數據
      const expressions = [
    { id: 'default', name: '默認表情', price: 0, className: '', type: 'expression' },
    { id: 'happy', name: '無奈', price: 20, className: 'happy', type: 'expression' },
    { id: 'angry', name: '生氣', price: 50, className: 'angry', type: 'expression' },
    { id: 'surprised', name: '驚訝', price: 100, className: 'surprised', type: 'expression' },
    { id: 'sad', name: '發呆', price: 150, className: 'sad', type: 'expression' },
    { id: 'wink', name: '反白眼', price: 200, className: 'wink', type: 'expression' },
    { id: 'hidden-emoji-1', name: '惺忪', price: 300, className: 'hidden-sleepy', isHidden: true, type: 'expression' },
    { id: 'hidden-emoji-2', name: '震驚', price: 300, className: 'hidden-shock-eyes', isHidden: true, type: 'expression' },
    { id: 'hidden-emoji-3', name: '冷酷', price: 300, className: 'hidden-cold', isHidden: true, type: 'expression' }
];

const hairstyles = [
    { id: 'default', name: '默認髮型', price: 0, className: '', type: 'hairstyle' },
    { id: 'hair-1', name: '短棕髮', price: 30, className: 'hair-1', type: 'hairstyle' },
    { id: 'hair-2', name: '金色波浪', price: 60, className: 'hair-2', type: 'hairstyle' },
    { id: 'hair-3', name: '橙色平頂', price: 90, className: 'hair-3', type: 'hairstyle' },
    { id: 'hair-4', name: '藍色尖髮', price: 120, className: 'hair-4', type: 'hairstyle' },
    { id: 'hair-5', name: '綠色層次', price: 150, className: 'hair-5', type: 'hairstyle' },
    { id: 'hair-6', name: '紫色弧形', price: 180, className: 'hair-6', type: 'hairstyle' },
    { id: 'hidden-hair-1', name: '彩虹流光髮', price: 400, className: 'hidden-hair-1', isHidden: true, type: 'hairstyle' },
    { id: 'hidden-hair-2', name: '星空銀河髮', price: 400, className: 'hidden-hair-2', isHidden: true, type: 'hairstyle' },
    { id: 'hidden-hair-3', name: '極光幻彩髮', price: 400, className: 'hidden-hair-3', isHidden: true, type: 'hairstyle' }
];

const personalities = [
    { id: 'default', name: '默認形象', price: 0, icon: '😐', className: 'personality-default', prompt: '', type: 'personality' },
    { id: 'gentle', name: '溫和親切', price: 30, icon: '😊', className: 'personality-gentle', prompt: '你要用非常溫和、親切、鼓勵的語氣回應，多用正面詞語，語調要溫柔體貼，像一個慈祥的長者。', type: 'personality' },
    { id: 'serious', name: '嚴肅認真', price: 50, icon: '😤', className: 'personality-serious', prompt: '你要用嚴肅、認真、專業的語氣回應，語調要正式，重視學術準確性，像一個嚴格的教授。', type: 'personality' },
    { id: 'cheerful', name: '開朗活潑', price: 80, icon: '😄', className: 'personality-cheerful', prompt: '你要用非常開朗、活潑、充滿活力的語氣回應，多用感嘆詞和積極詞語，語調要輕快愉悅。', type: 'personality' },
    { id: 'sarcastic', name: '諷刺毒舌', price: 120, icon: '😏', className: 'personality-sarcastic', prompt: '你要用諷刺、毒舌但不過分的語氣回應，可以適度調侃學生，但要保持教育意義，語調要略帶挖苦。要用日常生活的語言，不要用文言。', type: 'personality' },
    { id: 'wise', name: '睿智哲理', price: 150, icon: '🧙‍♂️', className: 'personality-wise', prompt: '你要用充滿智慧、哲理性的語氣回應，多引用名言警句和深刻見解，語調要深沉有內涵。', type: 'personality' },
    { id: 'humorous', name: '幽默搞笑', price: 200, icon: '🤣', className: 'personality-humorous', prompt: '你要用非常幽默、搞笑的語氣回應，多用比喻和笑話，但要與教學內容相關，語調要輕鬆風趣。', type: 'personality' },
    { id: 'hidden-wuxia', name: '武俠高手', price: 500, icon: '🗡️', className: 'personality-hidden-wuxia', isHidden: true, prompt: '你要用武俠小說的大俠語氣回應，如金庸小說中的大俠風格，使用江湖俠義用語，稱呼學生為「少俠」，讓學生感受大俠風範，語調要剛勁有力，充滿正義感。', type: 'personality' },
    { id: 'hidden-poet', name: '詩人雅士', price: 500, icon: '🖋️', className: 'personality-hidden-poet', isHidden: true, prompt: '你要用詩人的語氣回應，文辭優美，富有詩意，可適當引用古詩詞，稱呼學生為「足下」，語調要柔和飽含感情，表達要有意境。', type: 'personality' },
    { id: 'hidden-sage', name: '福爾摩斯', price: 500, icon: '📜', className: 'personality-hidden-sage', isHidden: true, prompt: '用1930年代黑色電影腔調說話，把每個問題當成案件。開場彈打火機音效[咔嚓]，稱對方"老兄"。關鍵線索用「係煙頭話我聽...」等現場證據比喻，結尾必說「呢個城市需要更加多好似你咁樣嘅的腦袋」', type: 'personality' }
];

const foods = [
    { id: 'apple', name: '蘋果', price: 3, nutrition: 15, emoji: '🍎', type: 'food' },
    { id: 'sandwich', name: '三明治', price: 5, nutrition: 30, emoji: '🥪', type: 'food' },
    { id: 'pizza', name: '披薩', price: 7, nutrition: 50, emoji: '🍕', type: 'food' },
    { id: 'burger', name: '漢堡', price: 10, nutrition: 65, emoji: '🍔', type: 'food' },
    { id: 'steak', name: '牛排', price: 12, nutrition: 80, emoji: '🥩', type: 'food' },
    { id: 'cake', name: '蛋糕', price: 15, nutrition: 100, emoji: '🎂', type: 'food' }
];

        // 新增盲盒系統
const mysteryboxes = [
    { 
        id: 'bronze', 
        name: '銅級盲盒', 
        price: 15, 
        class: 'mysterybox-bronze', 
        icon: '🎁',
        color: '#CD7F32',
        odds: {
            nothing: 0.3,        // 30% 機率什麼都沒抽到
            food: 0.4,           // 40% 機率抽到食物
            expression: 0.2,     // 20% 機率抽到表情
            hairstyle: 0.09,     // 9% 機率抽到髮型
            personality: 0.01    // 1% 機率抽到性格
        }
    },
    { 
        id: 'silver', 
        name: '銀級盲盒', 
        price: 30, 
        class: 'mysterybox-silver', 
        icon: '🎁',
        color: '#C0C0C0',
        odds: {
            nothing: 0.1,        // 10% 機率什麼都沒抽到
            food: 0.4,           // 40% 機率抽到食物
            expression: 0.25,     // 25% 機率抽到表情
            hairstyle: 0.15,     // 15% 機率抽到髮型
            personality: 0.05,    // 5% 機率抽到性格
            hidden: 0.05         // 5% 機率抽到隱藏版商品
        }
    },
    { 
        id: 'gold', 
        name: '金級盲盒', 
        price: 70, 
        class: 'mysterybox-gold', 
        icon: '🎁',
        color: '#FFD700',
        odds: {
            nothing: 0.05,       // 5% 機率什麼都沒抽到
            food: 0.3,           // 30% 機率抽到食物
            expression: 0.27,     // 27% 機率抽到表情
            hairstyle: 0.2,     // 20% 機率抽到髮型
            personality: 0.1,     // 10% 機率抽到性格
            hidden: 0.08         // 8% 機率抽到隱藏版商品
        }
    }
];
        
       // 用戶數據
let userData = {
    points: 10000,
    purchasedExpressions: ['default'],
    purchasedHairstyles: ['default'],
    purchasedFoods: [],
    purchasedPersonalities: ['default'],
    currentExpression: 'default',
    currentHairstyle: 'default',
    currentPersonality: 'default',
    hungerLevel: 100,
    lastFeedTime: Date.now(),
    vtuberName: '史萊姆',
    hiddenCodesUsed: []  // 新增：已使用的一次性密碼
};

        // 飽腹值衰減係數
        const HUNGER_DECAY_RATE = 0.5; // 每24小時減50%
        const HUNGER_DECAY_INTERVAL = 24 * 60 * 60 * 1000; // 24小時毫秒數

       // 初始化用戶數據
function initUserData() {
    if (currentUser) {
        database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
            const firebaseData = snapshot.val();
            if (firebaseData) {
                // 確保所有必要屬性存在
                userData = {
                    points: firebaseData.points || 20,
                    purchasedExpressions: firebaseData.purchasedExpressions || ['default'],
                    purchasedHairstyles: firebaseData.purchasedHairstyles || ['default'],
                    purchasedFoods: firebaseData.purchasedFoods || [],
                    purchasedPersonalities: firebaseData.purchasedPersonalities || ['default'],
                    currentExpression: firebaseData.currentExpression || 'default',
                    currentHairstyle: firebaseData.currentHairstyle || 'default',
                    currentPersonality: firebaseData.currentPersonality || 'default',
                    hungerLevel: firebaseData.hungerLevel || 100,
                    lastFeedTime: firebaseData.lastFeedTime || Date.now(),
                    vtuberName: firebaseData.vtuberName || firebaseData.characterName || '史萊姆',
                    hiddenCodesUsed: firebaseData.hiddenCodesUsed || [],
                    freeMysteryboxDraws: firebaseData.freeMysteryboxDraws || {}
                };
            } else {
                // 新用戶，初始化數據
                let defaultName = currentUser.email.split('@')[0];
                if (!defaultName.endsWith("蛋")) {
                    defaultName += "蛋";
                }
                initializeNewUserData(defaultName);
            }
            updatePointsDisplay();
            updateHungerDisplay();
            updateVtuberAppearance();
            syncUserAppearance();
            updateVtuberName();
        }).catch((error) => {
            console.error('從Firebase載入數據失敗:', error);
            // 創建默認數據
            let defaultName = currentUser.email.split('@')[0];
            if (!defaultName.endsWith("蛋")) {
                defaultName += "蛋";
            }
            initializeNewUserData(defaultName);
            updatePointsDisplay();
            updateHungerDisplay();
            updateVtuberAppearance();
            syncUserAppearance();
            updateVtuberName();
        });
    } else {
        // 未登入狀態，使用預設數據
        userData = {
            points: 20,
            purchasedExpressions: ['default'],
            purchasedHairstyles: ['default'],
            purchasedFoods: [],
            purchasedPersonalities: ['default'],
            currentExpression: 'default',
            currentHairstyle: 'default',
            currentPersonality: 'default',
            hungerLevel: 100,
            lastFeedTime: Date.now(),
            vtuberName: '史萊姆',
            hiddenCodesUsed: [],
            freeMysteryboxDraws: {}
        };
        updatePointsDisplay();
        updateHungerDisplay();
        updateVtuberAppearance();
        syncUserAppearance();
        updateVtuberName();
    }
    // 開始飽腹值定時更新
    setInterval(updateHungerLevel, 60000); // 每分鐘檢查一次
}


function initializeNewUserData(characterName) {
    const defaultUserData = {
        points: 20,
        purchasedExpressions: ['default'],
        purchasedHairstyles: ['default'],
        purchasedFoods: [],
        purchasedPersonalities: ['default'],
        currentExpression: 'default',
        currentHairstyle: 'default',
        currentPersonality: 'default',
        hungerLevel: 100,
        lastFeedTime: Date.now(),
        vtuberName: characterName,
        hiddenCodesUsed: [],
        freeMysteryboxDraws: {}
    };
    userData = defaultUserData;
    if (currentUser) {
        database.ref('users/' + currentUser.uid).update(defaultUserData)
            .catch((error) => {
                console.error('初始化新用戶數據失敗:', error);
            });
    }
}





        // 更新VTuber名稱顯示
       function updateVtuberName() {
    vtuberDisplayName.textContent = userData.vtuberName;
    currentNameDisplay.textContent = `當前名稱：${userData.vtuberName}`;
    // 更新所有聊天記錄中的AI消息名稱
    updateAllAIMessageNames();
}


        // 設置VTuber名稱
        function setVtuberName(name) {
    const trimmedName = name.trim();
    
    if (!trimmedName) {
        showNameError('名稱不能為空');
        return false;
    }
    
    if (trimmedName.length > 20) {
        showNameError('名稱長度不能超過20個字符');
        return false;
    }
    
    if (containsProfanity(trimmedName)) {
        showNameError('名稱包含不當詞語，請重新輸入');
        return false;
    }
    
    // 檢查名稱是否已以「蛋」結尾，若唔係就加上
    let finalName = trimmedName;
    if (!trimmedName.endsWith("蛋")) {
        finalName = trimmedName + "蛋";
    }
    
   userData.vtuberName = finalName;
updateVtuberName();

            // 更新已存在的聊天記錄中的名稱顯示
updateAllAIMessageNames();


// 同步到Firebase
if (currentUser) {
    database.ref('users/' + currentUser.uid + '/characterName').set(finalName)
        .catch((error) => {
            console.error('同步角色名稱到Firebase失敗:', error);
        });
}

// 顯示成功消息
showNameSuccess(`名稱已更改為：${finalName}`);
vtuberNameInput.value = '';

return true;
}

// 打開盲盒動畫和獎勵系統
// 3D盲盒動畫系統
let canvas, ctx;
let boxParts = {
    lid: { rotationX: 0, y: 0, opened: false },
    body: { y: 0 },
    confetti: []
};
let animationStartTime = 0;
let isBoxOpened = false;


// 3D立體盲盒動畫系統
function openMysteryBox(boxData) {
    // 重置動畫狀態
    const mysteryboxAnimation = document.getElementById('mysterybox-animation');
    const giftBox3d = document.getElementById('gift-box-3d');
    const resultContainer = document.getElementById('mysterybox-result-container');
    
    // 清除之前的動畫和紙屑
    giftBox3d.style.display = 'flex';
    giftBox3d.classList.remove('opening');
    resultContainer.classList.remove('show');
    document.querySelectorAll('.confetti-3d').forEach(el => el.remove());
    
    // 設置初始顯示
    mysteryboxAnimation.style.display = 'flex';
    giftBox3d.className = `gift-box-3d mysterybox-${boxData.id}`;
    
    // 抽獎邏輯
    const randomValue = Math.random();
    let accumulatedOdds = 0;
    let rewardType = 'nothing';
    for (const [type, odds] of Object.entries(boxData.odds)) {
        accumulatedOdds += odds;
        if (randomValue <= accumulatedOdds) {
            rewardType = type;
            break;
        }
    }
    
    // 使用 Promise 確保動畫順序
    return new Promise((resolve) => {
        setTimeout(() => {
            startMysteryBoxAnimation(rewardType);
            resolve();
        }, 1000);
    });
}
async function startMysteryBoxAnimation(rewardType) {
    const giftBox3d = document.getElementById('gift-box-3d');
    
    // 第一階段：搖晃動畫
    giftBox3d.style.animation = 'mysteryboxShake 2s ease-in-out';
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // 第二階段：打開動畫
    giftBox3d.style.animation = 'none'; // 清除搖晃動畫
    giftBox3d.classList.add('opening');
    giftBox3d.style.animation = 'mysteryboxFloat 3s ease-in-out infinite';
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // 第三階段：隱藏盒子並顯示結果
    giftBox3d.style.display = 'none';
    create3DConfetti();
    await showMysteryBoxResult(rewardType);
}

// 創建3D紙屑效果
function create3DConfetti() {
    const colors = ['#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#FFD700', '#FF69B4'];
    const confettiCount = 80;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-3d';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = `${Math.random() * 1}s`;
        confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
        
        // 隨機形狀
        if (Math.random() > 0.5) {
            confetti.style.borderRadius = '0';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        }
        
        mysteryboxAnimation.appendChild(confetti);
        
        // 動畫結束後移除
        setTimeout(() => {
            if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
            }
        }, 6000);
    }
}



function createRewardPreview(reward, rewardType, container) {
    container.innerHTML = '';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
    container.style.width = '100px';
    container.style.height = '100px';
    container.style.margin = '0 auto 15px';
    container.style.position = 'relative';
    container.style.overflow = 'hidden';
    container.style.borderRadius = '15px';
    container.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
    container.style.boxShadow = '0 0 20px rgba(255,215,0,0.6)';
    
    if (rewardType === 'expression' || rewardType === 'hidden') {
        // 表情預覽
        container.style.background = 'linear-gradient(135deg, #fde2e4, #fbb6ce)';
        container.style.borderRadius = '50%';
        
        const eyesDiv = document.createElement('div');
        eyesDiv.className = 'expression-eyes';
        eyesDiv.style.cssText = `
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        `;
        
        for (let i = 0; i < 2; i++) {
            const eyeDiv = document.createElement('div');
            eyeDiv.className = 'expression-eye';
            eyeDiv.style.cssText = `
                width: 20px;
                height: 12px;
                background: #fff;
                border-radius: 50%;
                position: relative;
            `;
            const pupilDiv = document.createElement('div');
            pupilDiv.className = 'expression-pupil';
            pupilDiv.style.cssText = `
                width: 8px;
                height: 8px;
                background: #333;
                border-radius: 50%;
                position: absolute;
                top: 2px;
                left: 6px;
            `;
            eyeDiv.appendChild(pupilDiv);
            eyesDiv.appendChild(eyeDiv);
        }
        
        const mouthDiv = document.createElement('div');
        mouthDiv.className = 'expression-mouth';
        mouthDiv.style.cssText = `
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        `;
        
        const mouthInnerDiv = document.createElement('div');
        mouthInnerDiv.className = 'expression-mouth-inner';
        mouthInnerDiv.style.cssText = `
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        `;
        mouthDiv.appendChild(mouthInnerDiv);
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.appendChild(eyesDiv);
        container.appendChild(mouthDiv);
        
    } else if (rewardType === 'hairstyle') {
        // 髮型預覽
        container.style.background = 'linear-gradient(135deg, #fde2e4, #fbb6ce)';
        container.style.borderRadius = '50%';
        
        const hairDiv = document.createElement('div');
        hairDiv.className = 'vtuber-hair';
        hairDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        `;
        
        if (reward.className) {
            hairDiv.classList.add(reward.className);
        }
        
        container.appendChild(hairDiv);
        
    } else if (rewardType === 'personality') {
        // 性格預覽
        container.style.borderRadius = '20px';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.fontSize = '3rem';
        container.style.color = 'white';
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.textContent = reward.icon;
    }
}







function showMysteryBoxResult(rewardType) {
    const resultContainer = document.getElementById('mysterybox-result-container');
    const resultIcon = document.getElementById('mysterybox-result-icon');
    const resultText = document.getElementById('mysterybox-result-text');
    
    let reward = null;
    let rewardText = '';
    
    if (rewardType === 'nothing') {
        rewardText = '什麼都沒抽到...';
        resultIcon.textContent = '❌';
    } else if (rewardType === 'hidden') {
        const hiddenExpressions = expressions.filter(item => item.isHidden);
        const hiddenHairstyles = hairstyles.filter(item => item.isHidden);
        const hiddenPersonalities = personalities.filter(item => item.isHidden);
        
        const allHiddenItems = [...hiddenExpressions, ...hiddenHairstyles, ...hiddenPersonalities];
        
        const unownedHiddenItems = allHiddenItems.filter(item => {
            if (item.type === 'expression') {
                return !userData.purchasedExpressions.includes(item.id);
            } else if (item.type === 'hairstyle') {
                return !userData.purchasedHairstyles.includes(item.id);
            } else if (item.type === 'personality') {
                return !userData.purchasedPersonalities.includes(item.id);
            }
        });
        
        if (unownedHiddenItems.length > 0) {
            reward = unownedHiddenItems[Math.floor(Math.random() * unownedHiddenItems.length)];
            if (reward.type === 'expression') {
                userData.purchasedExpressions.push(reward.id);
                rewardText = `獲得隱藏表情：${reward.name}！`;
            } else if (reward.type === 'hairstyle') {
                userData.purchasedHairstyles.push(reward.id);
                rewardText = `獲得隱藏髮型：${reward.name}！`;
            } else if (reward.type === 'personality') {
                userData.purchasedPersonalities.push(reward.id);
                rewardText = `獲得隱藏性格：${reward.name}！`;
            }
        } else {
            reward = getRandomItem(foods);
            if (reward) {
                userData.purchasedFoods.push(reward.id);
                rewardText = `獲得食物：${reward.name}！`;
            }
        }
    } else {
        switch (rewardType) {
            case 'food':
                reward = getRandomItem(foods);
                if (reward) {
                    userData.purchasedFoods.push(reward.id);
                    rewardText = `獲得食物：${reward.name}！`;
                }
                break;
            case 'expression':
                reward = getRandomUnownedItem(expressions.filter(e => !e.isHidden), userData.purchasedExpressions);
                if (reward) {
                    userData.purchasedExpressions.push(reward.id);
                    rewardText = `獲得表情：${reward.name}！`;
                } else {
                    reward = getRandomItem(foods);
                    if (reward) {
                        userData.purchasedFoods.push(reward.id);
                        rewardText = `獲得食物：${reward.name}！`;
                    }
                }
                break;
            case 'hairstyle':
                reward = getRandomUnownedItem(hairstyles.filter(h => !h.isHidden), userData.purchasedHairstyles);
                if (reward) {
                    userData.purchasedHairstyles.push(reward.id);
                    rewardText = `獲得髮型：${reward.name}！`;
                } else {
                    reward = getRandomItem(foods);
                    if (reward) {
                        userData.purchasedFoods.push(reward.id);
                        rewardText = `獲得食物：${reward.name}！`;
                    }
                }
                break;
            case 'personality':
                reward = getRandomUnownedItem(personalities.filter(p => !p.isHidden), userData.purchasedPersonalities);
                if (reward) {
                    userData.purchasedPersonalities.push(reward.id);
                    rewardText = `獲得性格：${reward.name}！`;
                } else {
                    reward = getRandomItem(foods);
                    if (reward) {
                        userData.purchasedFoods.push(reward.id);
                        rewardText = `獲得食物：${reward.name}！`;
                    }
                }
                break;
        }
    }
    
    // 如果有獎勵，根據實際獲得的reward更新rewardType
    if (reward) {
        rewardType = reward.type;
    }
    
    // 設置獎勵顯示
    if (reward && (rewardType === 'expression' || rewardType === 'hairstyle' || rewardType === 'personality')) {
        createRewardPreview(reward, rewardType, resultIcon);
    } else if (rewardType === 'food') {
        resultIcon.textContent = reward.emoji;
    } else {
        resultIcon.textContent = '❌';
    }
    
    resultText.innerHTML = `<div style="text-align: center; line-height: 1.6; font-weight: bold; color: #333; font-size: 1.2rem;">${rewardText}</div>`;
    
    // 顯示結果容器
    setTimeout(() => {
        resultContainer.classList.add('show');
    }, 500);
    
    // 保存用戶數據
    saveUserData();
    
    // 顯示獲得的獎勵通知
    showNotification(rewardText);
    
    // 3秒後自動關閉動畫
    setTimeout(() => {
        mysteryboxAnimation.style.display = 'none';
        resultContainer.classList.remove('show');
        const giftBox3d = document.getElementById('gift-box-3d');
        giftBox3d.classList.remove('opening');
        giftBox3d.style.display = 'flex';
        
        const confettiElements = mysteryboxAnimation.querySelectorAll('.confetti-3d');
        confettiElements.forEach(el => el.remove());
    }, 3000);
}

function createRewardPreview(reward, rewardType, container) {
    container.innerHTML = '';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
    container.style.width = '80px';
    container.style.height = '80px';
    container.style.margin = '0 auto 15px';
    container.style.position = 'relative';
    container.style.overflow = 'hidden';
    
    if (rewardType === 'expression' || rewardType === 'hidden') {
        // 表情預覽
        container.style.background = '#fde2e4';
        container.style.borderRadius = '50%';
        
        const eyesDiv = document.createElement('div');
        eyesDiv.className = 'expression-eyes';
        eyesDiv.style.cssText = `
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        `;
        
        for (let i = 0; i < 2; i++) {
            const eyeDiv = document.createElement('div');
            eyeDiv.className = 'expression-eye';
            eyeDiv.style.cssText = `
                width: 20px;
                height: 12px;
                background: #fff;
                border-radius: 50%;
                position: relative;
            `;
            const pupilDiv = document.createElement('div');
            pupilDiv.className = 'expression-pupil';
            pupilDiv.style.cssText = `
                width: 8px;
                height: 8px;
                background: #333;
                border-radius: 50%;
                position: absolute;
                top: 2px;
                left: 6px;
            `;
            eyeDiv.appendChild(pupilDiv);
            eyesDiv.appendChild(eyeDiv);
        }
        
        const mouthDiv = document.createElement('div');
        mouthDiv.className = 'expression-mouth';
        mouthDiv.style.cssText = `
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #ff9aa2;
            border-radius: 0 0 15px 15px;
            overflow: hidden;
            z-index: 2;
        `;
        
        const mouthInnerDiv = document.createElement('div');
        mouthInnerDiv.className = 'expression-mouth-inner';
        mouthInnerDiv.style.cssText = `
            width: 100%;
            height: 6px;
            background: #990000;
            border-radius: 50% / 100%;
            position: absolute;
            bottom: 0;
        `;
        mouthDiv.appendChild(mouthInnerDiv);
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.appendChild(eyesDiv);
        container.appendChild(mouthDiv);
        
    } else if (rewardType === 'hairstyle') {
        // 髮型預覽
        container.style.background = '#fde2e4';
        container.style.borderRadius = '50%';
        
        const hairDiv = document.createElement('div');
        hairDiv.className = 'vtuber-hair';
        hairDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            z-index: 2;
        `;
        
        if (reward.className) {
            hairDiv.classList.add(reward.className);
        }
        
        container.appendChild(hairDiv);
        
    } else if (rewardType === 'personality') {
        // 性格預覽
        container.style.borderRadius = '15px';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.fontSize = '2.5rem';
        container.style.color = 'white';
        
        if (reward.className) {
            container.classList.add(reward.className);
        }
        
        container.textContent = reward.icon;
    }
}




        // 顯示名稱錯誤消息
        function showNameError(message) {
            clearNameMessages();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message-input';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            vtuberNameInput.parentNode.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        // 顯示名稱成功消息
        function showNameSuccess(message) {
            clearNameMessages();
            const successDiv = document.createElement('div');
            successDiv.className = 'warning-message';
            successDiv.style.backgroundColor = '#d4edda';
            successDiv.style.color = '#155724';
            successDiv.style.borderColor = '#c3e6cb';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            vtuberNameInput.parentNode.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // 清除名稱消息
        function clearNameMessages() {
            const messages = vtuberNameInput.parentNode.querySelectorAll('.error-message-input, .warning-message[style]');
            messages.forEach(msg => {
                if (msg.parentNode) {
                    msg.parentNode.removeChild(msg);
                }
            });
        }

        // 更新飽腹值
        function updateHungerLevel() {
            const currentTime = Date.now();
            const timeDifference = currentTime - userData.lastFeedTime;
            const decayIntervals = timeDifference / HUNGER_DECAY_INTERVAL;
            
            if (decayIntervals > 0) {
                // 計算衰減後的飽腹值
                const decayAmount = userData.hungerLevel * HUNGER_DECAY_RATE * decayIntervals;
                userData.hungerLevel = Math.max(0, userData.hungerLevel - decayAmount);
                userData.lastFeedTime = currentTime;
                saveUserData();
            }
            
            updateHungerDisplay();
            updateVtuberAppearance();
syncUserAppearance();
        }

        // 更新飽腹值顯示
        function updateHungerDisplay() {
            const percentage = Math.round(userData.hungerLevel);
            hungerPercentage.textContent = percentage + '%';
            hungerFill.style.width = percentage + '%';
            
            // 重置所有狀態類
            hungerIcon.className = 'fas fa-drumstick-bite hunger-icon';
            hungerFill.className = 'hunger-fill';
            
            if (percentage <= 25) {
                hungerIcon.classList.add('very-hungry');
                hungerFill.classList.add('very-hungry');
            } else if (percentage <= 50) {
                hungerIcon.classList.add('hungry');
                hungerFill.classList.add('hungry');
            }
        }

        // 保存用戶數據到localStorage和Firebase
function saveUserData() {
    if (currentUser) {
        const dataToSave = {
            points: userData.points,
            purchasedExpressions: userData.purchasedExpressions,
            purchasedHairstyles: userData.purchasedHairstyles,
            purchasedFoods: userData.purchasedFoods,
            purchasedPersonalities: userData.purchasedPersonalities,
            currentExpression: userData.currentExpression,
            currentHairstyle: userData.currentHairstyle,
            currentPersonality: userData.currentPersonality,
            hungerLevel: userData.hungerLevel,
            lastFeedTime: userData.lastFeedTime,
            hiddenCodesUsed: userData.hiddenCodesUsed || [],
            freeMysteryboxDraws: userData.freeMysteryboxDraws || {},
            vtuberName: userData.vtuberName
        };
        
        database.ref('users/' + currentUser.uid).update(dataToSave)
            .catch((error) => {
                console.error('保存數據到Firebase失敗:', error);
            });
    }
}


// 同步當前用戶的外觀信息供其他用戶查看
function syncUserAppearance() {
    if (currentUser) {
        const appearanceData = {
            currentExpression: userData.currentExpression,
            currentHairstyle: userData.currentHairstyle,
            lastUpdated: Date.now()
        };
        database.ref('users/' + currentUser.uid + '/vtuberAppearance').set(appearanceData)
            .catch((error) => {
                console.error('同步VTUBER外觀到Firebase失敗:', error);
            });
    }
}




// 同步Firebase數據到本地
function syncFirebaseDataToLocal() {
    database.ref('users/' + currentUser.uid).on('value', (snapshot) => {
        const firebaseData = snapshot.val();
        if (firebaseData) {
            // 同步點數
            if (firebaseData.points !== undefined) {
                userData.points = firebaseData.points;
                updatePointsDisplay();
            }
            
            // 同步飽腹值
            if (firebaseData.hungerLevel !== undefined) {
                userData.hungerLevel = firebaseData.hungerLevel;
                updateHungerDisplay();
            }
            
            // 同步購買記錄
            if (firebaseData.purchasedExpressions) {
                userData.purchasedExpressions = firebaseData.purchasedExpressions;
            }
            if (firebaseData.purchasedHairstyles) {
                userData.purchasedHairstyles = firebaseData.purchasedHairstyles;
            }
            if (firebaseData.purchasedPersonalities) {
                userData.purchasedPersonalities = firebaseData.purchasedPersonalities;
            }
            if (firebaseData.purchasedFoods) {
                userData.purchasedFoods = firebaseData.purchasedFoods;
            }
            
            // 同步當前使用的外觀
            if (firebaseData.vtuberAppearance) {
                userData.currentExpression = firebaseData.vtuberAppearance.currentExpression || 'default';
                userData.currentHairstyle = firebaseData.vtuberAppearance.currentHairstyle || 'default';
            }
            
            // 同步角色名稱
            if (firebaseData.characterName) {
                userData.vtuberName = firebaseData.characterName;
                updateVtuberName();
            }
            
            saveUserData();
            updateVtuberAppearance();
        }
    });
}

// 同步本地數據到Firebase
function syncLocalDataToFirebase() {
    if (currentUser) {
        const syncData = {
            points: userData.points,
            hungerLevel: userData.hungerLevel,
            purchasedExpressions: userData.purchasedExpressions,
            purchasedHairstyles: userData.purchasedHairstyles,
            purchasedPersonalities: userData.purchasedPersonalities,
            purchasedFoods: userData.purchasedFoods,
            characterName: userData.vtuberName,
            vtuberAppearance: {
                currentExpression: userData.currentExpression,
                currentHairstyle: userData.currentHairstyle,
                lastUpdated: Date.now()
            }
        };
        
        database.ref('users/' + currentUser.uid).update(syncData)
            .catch((error) => {
                console.error('同步數據到Firebase失敗:', error);
            });
    }
}


        // 更新點數顯示
        function updatePointsDisplay() {
            pointsDisplay.textContent = userData.points + ' ';
            shopPoints.textContent = userData.points;
        }

        // 更新VTuber外觀
        function updateVtuberAppearance() {
            const expression = expressions.find(e => e.id === userData.currentExpression);
            const hairstyle = hairstyles.find(h => h.id === userData.currentHairstyle);
            
            vtuberFace.className = 'vtuber-face';
            vtuberHair.className = 'vtuber-hair';
            
            // 添加飢餓狀態
            if (userData.hungerLevel <= 25) {
                vtuberFace.classList.add('very-hungry');
            } else if (userData.hungerLevel <= 50) {
                vtuberFace.classList.add('hungry');
            }
            
            if (expression && expression.className) {
                vtuberFace.classList.add(expression.className);
            }
            if (hairstyle && hairstyle.className) {
                vtuberHair.classList.add(hairstyle.className);
            }
            
            if (isTalking) {
                vtuberMouth.classList.add('talking');
            }
        }

        // 增加點數
        function addPoints(amount) {
            userData.points += amount;
            updatePointsDisplay();
            saveUserData();
        }

        // 購買商品
        function purchaseItem(itemId, type) {
            let items, purchasedArray;
            
            if (type === 'expression') {
                items = expressions;
                purchasedArray = userData.purchasedExpressions;
            } else if (type === 'hairstyle') {
                items = hairstyles;
                purchasedArray = userData.purchasedHairstyles;
            } else if (type === 'food') {
                items = foods;
                purchasedArray = userData.purchasedFoods;
            } else if (type === 'personality') {
                items = personalities;
                purchasedArray = userData.purchasedPersonalities;
            } else if (type === 'mysterybox') {
    items = mysteryboxes;
    const mysterybox = items.find(i => i.id === itemId);
    if (mysterybox) {
        // 檢查是否有免費抽獎次數
        const freeDraws = userData.freeMysteryboxDraws || {};
        const availableFreeDraws = freeDraws[itemId] || 0;
        
        if (availableFreeDraws > 0) {
            // 使用免費抽獎次數
            userData.freeMysteryboxDraws[itemId] = availableFreeDraws - 1;
            saveUserData();
            openMysteryBox(mysterybox);
            return true;
        } else if (userData.points >= mysterybox.price) {
            // 正常購買
            userData.points -= mysterybox.price;
            updatePointsDisplay();
            saveUserData();
            openMysteryBox(mysterybox);
            return true;
        }
    }
    return false;
}

            
            const item = items.find(i => i.id === itemId);
            if (!item) return false;
            
            if (userData.points >= item.price) {
                userData.points -= item.price;
                if (!purchasedArray.includes(itemId) || type === 'food') {
                    purchasedArray.push(itemId);
                }
                updatePointsDisplay();
                saveUserData();
                return true;
            }
            return false;
        }

        // 切換外觀或使用食物
        function useItem(itemId, type) {
            if (type === 'expression') {
                if (userData.purchasedExpressions.includes(itemId)) {
                    userData.currentExpression = itemId;
                    saveUserData();
                    updateVtuberAppearance();
syncUserAppearance();
                    return true;
                }
            } else if (type === 'hairstyle') {
                if (userData.purchasedHairstyles.includes(itemId)) {
                    userData.currentHairstyle = itemId;
                    saveUserData();
                    updateVtuberAppearance();
                    return true;
                }
            } else if (type === 'personality') {
                if (userData.purchasedPersonalities.includes(itemId)) {
                    userData.currentPersonality = itemId;
                    saveUserData();
                    return true;
                }
            } else if (type === 'food') {
                if (userData.purchasedFoods.includes(itemId)) {
                    const food = foods.find(f => f.id === itemId);
                    if (food) {
                        // 播放進食動畫
                        playEatingAnimation();
                        
                        // 增加飽腹值
                        userData.hungerLevel = Math.min(100, userData.hungerLevel + food.nutrition);
                        userData.lastFeedTime = Date.now();
                        
                        // 消耗食物
                        const index = userData.purchasedFoods.indexOf(itemId);
                        userData.purchasedFoods.splice(index, 1);
                        
                        saveUserData();
                        updateHungerDisplay();
                        updateVtuberAppearance();
syncUserAppearance();
                        return true;
                    }
                }
            }
            return false;
        }

        // 播放進食動畫
        function playEatingAnimation() {
            vtuberMouth.classList.add('eating');
            setTimeout(() => {
                vtuberMouth.classList.remove('eating');
            }, 1500);
        }

        // 獲取正確的商品類型名稱
        function getItemType(tab) {
            const typeMap = {
                'expressions': 'expression',
                'hairstyles': 'hairstyle',
                'foods': 'food',
                'personalities': 'personality',
                'mysteryboxes': 'mysterybox'
            };
            return typeMap[tab] || tab.slice(0, -1);
        }

       

// 獲取所有隱藏商品
function getAllHiddenItems() {
    const hiddenExpressions = expressions.filter(item => item.isHidden);
    const hiddenHairstyles = hairstyles.filter(item => item.isHidden);
    const hiddenPersonalities = personalities.filter(item => item.isHidden);
    return [...hiddenExpressions, ...hiddenHairstyles, ...hiddenPersonalities];
}

// 渲染商店商品
function renderShopItems(tab = 'expressions') {
    shopItems.innerHTML = '';
    if (!shopTabs[0].parentElement.querySelector('[data-tab="gifts"]')) {
    const giftTab = document.createElement('button');
    giftTab.className = 'tab';
    giftTab.dataset.tab = 'gifts';
    giftTab.textContent = '禮物';
    shopTabs[0].parentElement.appendChild(giftTab);
    
    // 修復：正確處理標籤切換邏輯
giftTab.addEventListener('click', () => {
    // 移除所有標籤的active狀態，包括原有和新添加的標籤
    const allTabs = giftTab.parentElement.querySelectorAll('.tab');
    allTabs.forEach(t => t.classList.remove('active'));
    giftTab.classList.add('active');
    renderShopItems('gifts');
});

}


 // 處理禮物標籤內容
    if (tab === 'gifts') {
        if (!currentUser) {
            shopItems.innerHTML = '<p>請先登入查看禮物！</p>';
            return;
        }
        
        database.ref('users/' + currentUser.uid + '/gifts').once('value').then((snapshot) => {
            shopItems.innerHTML = '';
            if (snapshot.exists()) {
                const gifts = snapshot.val();
                Object.entries(gifts).forEach(([giftId, gift]) => {
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'received-gift-item';
                    giftDiv.style.cssText = `
                        padding: 15px;
                        margin-bottom: 10px;
                        background: white;
                        border-radius: 10px;
                        border-left: 4px solid #ff6b9d;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    `;
                    // 獲取商品圖片
// 獲取商品實際預覽圖片
let itemPreviewElement = '';
if (gift.itemType === 'expression') {
    const expressionItem = expressions.find(e => e.id === gift.itemId);
    if (expressionItem) {
        itemPreviewElement = `
            <div class="item-preview expression-preview ${expressionItem.className || ''}" style="width: 60px; height: 60px; margin: 0;">
                <div class="expression-eyes">
                    <div class="expression-eye"><div class="expression-pupil"></div></div>
                    <div class="expression-eye"><div class="expression-pupil"></div></div>
                </div>
                <div class="expression-mouth"><div class="expression-mouth-inner"></div></div>
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">😊</div>';
    }
} else if (gift.itemType === 'hairstyle') {
    const hairstyleItem = hairstyles.find(h => h.id === gift.itemId);
    if (hairstyleItem) {
        itemPreviewElement = `
            <div class="item-preview" style="width: 60px; height: 60px; margin: 0; position: relative; background: #fde2e4; border-radius: 50%;">
                <div class="vtuber-hair ${hairstyleItem.className || ''}" style="width: 100%; height: 60%;"></div>
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">💇</div>';
    }
} else if (gift.itemType === 'personality') {
    const personalityItem = personalities.find(p => p.id === gift.itemId);
    if (personalityItem) {
        itemPreviewElement = `
            <div class="item-preview personality-preview ${personalityItem.className}" style="width: 60px; height: 60px; margin: 0; font-size: 2rem; color: white;">
                ${personalityItem.icon}
            </div>
        `;
    } else {
        itemPreviewElement = '<div style="font-size: 2.5rem;">🎭</div>';
    }
} else {
    itemPreviewElement = '<div style="font-size: 2.5rem;">🎁</div>';
}

giftDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 15px;">
        ${itemPreviewElement}
        <div style="flex: 1;">
            <strong>${gift.itemName}</strong><br>
            <small>來自: ${gift.fromName}</small>
        </div>
    </div>
    <button class="shop-btn use-btn" onclick="claimGift('${giftId}', '${gift.itemId}', '${gift.itemType}')">領取</button>
`;

                    shopItems.appendChild(giftDiv);
                });
            } else {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = `
                    text-align: center;
                    padding: 40px;
                    color: #666;
                `;
                emptyDiv.innerHTML = `
                    <i class="fas fa-gift" style="font-size: 3rem; margin-bottom: 20px; color: #ddd;"></i>
                    <p>你還沒有收到任何禮物！</p>
                `;
                shopItems.appendChild(emptyDiv);
            }
        }).catch((error) => {
            console.error('載入禮物失敗:', error);
            shopItems.innerHTML = '<p>載入禮物時發生錯誤，請稍後再試。</p>';
        });
        return;
    }


    let items, purchasedArray, currentItem;
    
    if (tab === 'expressions') {
        items = expressions;
        purchasedArray = userData.purchasedExpressions;
        currentItem = userData.currentExpression;
    } else if (tab === 'hairstyles') {
        items = hairstyles;
        purchasedArray = userData.purchasedHairstyles;
        currentItem = userData.currentHairstyle;
    } else if (tab === 'foods') {
    items = foods;
    purchasedArray = userData.purchasedFoods;
    currentItem = null;
    } else if (tab === 'personalities') {
        items = personalities;
        purchasedArray = userData.purchasedPersonalities;
        currentItem = userData.currentPersonality;
    } else if (tab === 'mysteryboxes') {
        items = mysteryboxes;
        purchasedArray = [];
        currentItem = null;
        




// 為盲盒創建特殊渲染邏輯
        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            
            const previewDiv = document.createElement('div');
            previewDiv.className = `item-preview mysterybox-preview ${item.class}`;
            previewDiv.textContent = item.icon;
            
            const nameElement = document.createElement('h3');
            nameElement.textContent = item.name;
            
            const priceElement = document.createElement('div');
            priceElement.className = 'price';
            priceElement.textContent = `${item.price} 點`;
            
           const buttonElement = document.createElement('button');
const freeDraws = (userData.freeMysteryboxDraws && userData.freeMysteryboxDraws[item.id]) || 0;

if (freeDraws > 0) {
    buttonElement.className = 'shop-btn use-btn';
    buttonElement.disabled = false;
    buttonElement.textContent = `免費抽獎 (${freeDraws})`;
    buttonElement.style.background = '#50c878';
} else {
    buttonElement.className = 'shop-btn buy-btn';
    buttonElement.disabled = userData.points < item.price;
    buttonElement.textContent = '抽獎';
}

            buttonElement.onclick = (e) => {
    e.stopPropagation(); // 阻止事件冒泡
    if (purchaseItem(item.id, 'mysterybox')) {
                    // 抽盲盒邏輯在 purchaseItem 中處理
                }
            };
            
            const descElement = document.createElement('p');
            descElement.style.fontSize = '0.8rem';
            descElement.style.marginTop = '10px';
            
            // 顯示隱藏商品機率信息
            if (item.id === 'silver' || item.id === 'gold') {
                const hiddenChance = item.id === 'silver' ? '5%' : '8%';
                descElement.innerHTML = `內含隨機驚喜!<br><span style="color:#9370DB">有${hiddenChance}機率抽中隱藏商品!</span>`;
            } else {
                descElement.textContent = '內含隨機驚喜!';
            }
            
            itemDiv.appendChild(previewDiv);
            itemDiv.appendChild(nameElement);
            itemDiv.appendChild(priceElement);
            itemDiv.appendChild(buttonElement);
            itemDiv.appendChild(descElement);

// 修改盲盒的送禮圖標
const giftIcon = document.createElement('i');
giftIcon.className = 'fas fa-gift gift-icon';
giftIcon.style.position = 'absolute';
giftIcon.style.top = '5px';
giftIcon.style.left = '5px';
giftIcon.style.cursor = 'pointer';
giftIcon.onclick = (e) => {
    e.stopPropagation();
    openMysteryboxGiftModal(item);
};
itemDiv.appendChild(giftIcon);

            shopItems.appendChild(itemDiv);
        });

        
        // 添加隱藏商品換領區
        const redeemDiv = document.createElement('div');
        redeemDiv.className = 'shop-item hidden-redeem';
        redeemDiv.style.gridColumn = '1 / -1';
        redeemDiv.style.background = 'linear-gradient(135deg, #8a2be2, #4b0082)';
        redeemDiv.style.padding = '20px';
        redeemDiv.style.marginTop = '20px';
        
        const redeemTitle = document.createElement('h3');
        redeemTitle.textContent = '隱藏商品換領';
        redeemTitle.style.color = 'white';
        redeemTitle.style.marginBottom = '15px';
        
        const redeemDesc = document.createElement('p');
        redeemDesc.textContent = '輸入陳SIR提供的一次性密碼，可隨機獲得一款隱藏版商品！';
        redeemDesc.style.color = 'white';
        redeemDesc.style.marginBottom = '15px';
        
        const codeInputGroup = document.createElement('div');
        codeInputGroup.style.display = 'flex';
        codeInputGroup.style.gap = '10px';
        codeInputGroup.style.marginBottom = '10px';
        
        const codeInput = document.createElement('input');
        codeInput.type = 'text';
        codeInput.placeholder = '輸入一次性密碼...';
        codeInput.style.flex = '1';
        codeInput.style.padding = '10px';
        codeInput.style.borderRadius = '5px';
        codeInput.style.border = 'none';
        
        const redeemButton = document.createElement('button');
        redeemButton.textContent = '換領';
        redeemButton.className = 'shop-btn buy-btn';
        redeemButton.style.width = 'auto';
        
       redeemButton.onclick = async () => {
    const code = codeInput.value.trim();
    if (!code) {
        showNotification('請輸入有效的換領碼');
        return;
    }
    
    try {
        // 檢查 Firebase 中的密碼狀態
        const codeRef = database.ref(`hiddenCodes/${code}`);
        const snapshot = await codeRef.once('value');
        const codeData = snapshot.val();
        
        if (!codeData || !codeData.valid) {
            showNotification('無效的換領碼');
            return;
        }
        
        if (codeData.used) {
            showNotification('此換領碼已經使用過了');
            return;
        }
        
        // 檢查本地是否已使用
        if (userData.hiddenCodesUsed.includes(code)) {
            showNotification('此換領碼已經使用過了');
            return;
        }
        
        // 隨機獲得一個隱藏商品
        const hiddenItems = getAllHiddenItems();
        const unownedHiddenItems = hiddenItems.filter(item => {
            if (item.id.includes('hidden-emoji')) {
                return !userData.purchasedExpressions.includes(item.id);
            } else if (item.id.includes('hidden-hair')) {
                return !userData.purchasedHairstyles.includes(item.id);
            } else if (item.id.includes('hidden-')) {
                return !userData.purchasedPersonalities.includes(item.id);
            }
            return false;
        });
        
        if (unownedHiddenItems.length === 0) {
            showNotification('您已擁有所有隱藏商品！');
            return;
        }
        
        const randomItem = unownedHiddenItems[Math.floor(Math.random() * unownedHiddenItems.length)];
        
        // 更新 Firebase 中的密碼狀態
        await codeRef.update({
            used: true
        });
        
        // 添加到用戶的已擁有商品
        if (randomItem.id.includes('hidden-emoji')) {
            userData.purchasedExpressions.push(randomItem.id);
        } else if (randomItem.id.includes('hidden-hair')) {
            userData.purchasedHairstyles.push(randomItem.id);
        } else if (randomItem.id.includes('hidden-')) {
            userData.purchasedPersonalities.push(randomItem.id);
        }
        
        // 記錄已使用的換領碼
        userData.hiddenCodesUsed.push(code);
        saveUserData();
        
        // 顯示獲得的獎勵
        showNotification(`恭喜獲得隱藏商品：${randomItem.name}！`);
        codeInput.value = '';
        
        // 如果當前標籤與獲得商品類型相符，刷新顯示
        if ((randomItem.id.includes('hidden-emoji') && tab === 'expressions') ||
            (randomItem.id.includes('hidden-hair') && tab === 'hairstyles') ||
            (randomItem.id.includes('hidden-') && !randomItem.id.includes('hidden-emoji') && 
             !randomItem.id.includes('hidden-hair') && tab === 'personalities')) {
            renderShopItems(tab);
        }
        
    } catch (error) {
        console.error('Firebase 錯誤:', error);
        showNotification('系統錯誤，請稍後再試');
    }
};

        
        codeInputGroup.appendChild(codeInput);
        codeInputGroup.appendChild(redeemButton);
        
        redeemDiv.appendChild(redeemTitle);
        redeemDiv.appendChild(redeemDesc);
        redeemDiv.appendChild(codeInputGroup);
        
        shopItems.appendChild(redeemDiv);
        
        return;
    }

    items.forEach(item => {
        const isOwned = purchasedArray.includes(item.id);
        const isActive = currentItem === item.id;
        const ownedCount = tab === 'foods' ? purchasedArray.filter(id => id === item.id).length : 0;
        const isHidden = item.isHidden && !isOwned;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = `shop-item ${isOwned ? 'owned' : ''} ${isHidden ? 'hidden-item' : ''}`;
        
        const previewDiv = document.createElement('div');
        let previewClass = '';
        
        if (tab === 'expressions') {
            previewClass = 'expression-preview';
        } else if (tab === 'foods') {
            previewClass = 'food-preview';
        } else if (tab === 'personalities') {
            previewClass = 'personality-preview';
        }
        
        previewDiv.className = `item-preview ${previewClass} ${!isHidden ? item.className || '' : ''}`;
        
        if (!isHidden) {
            if (tab === 'expressions') {
                const eyesDiv = document.createElement('div');
                eyesDiv.className = 'expression-eyes';
                for (let i = 0; i < 2; i++) {
                    const eyeDiv = document.createElement('div');
                    eyeDiv.className = 'expression-eye';
                    const pupilDiv = document.createElement('div');
                    pupilDiv.className = 'expression-pupil';
                    eyeDiv.appendChild(pupilDiv);
                    eyesDiv.appendChild(eyeDiv);
                }
                const mouthDiv = document.createElement('div');
                mouthDiv.className = 'expression-mouth';
                const mouthInnerDiv = document.createElement('div');
                mouthInnerDiv.className = 'expression-mouth-inner';
                mouthDiv.appendChild(mouthInnerDiv);
                previewDiv.appendChild(eyesDiv);
                previewDiv.appendChild(mouthDiv);
            } else if (tab === 'foods') {
                previewDiv.textContent = item.emoji;
            } else if (tab === 'personalities') {
                previewDiv.textContent = item.icon;
            }
        }
        
        const nameElement = document.createElement('h3');
        nameElement.textContent = isHidden ? '???' : (item.name + (tab === 'foods' && ownedCount > 0 ? ` (${ownedCount})` : ''));
        
        const priceElement = document.createElement('div');
        priceElement.className = 'price';
        if (tab === 'foods') {
            priceElement.textContent = `${item.price} 點 (+${item.nutrition}飽腹)`;
        } else {
            priceElement.textContent = isHidden ? '???' : `${item.price} 點`;
        }
        
        const buttonElement = document.createElement('button');
        const itemType = getItemType(tab);
        
        if (isHidden) {
            buttonElement.className = 'shop-btn buy-btn';
            buttonElement.textContent = '未解鎖';
            buttonElement.disabled = true;
        } else if (tab === 'foods') {
            if (ownedCount > 0) {
                buttonElement.className = 'shop-btn use-btn';
                buttonElement.textContent = '投餵';
                buttonElement.onclick = () => {
                    if (useItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`投餵了${item.name}，飽腹值增加${item.nutrition}！`, 'ai');
                    }
                };
            } else {
                buttonElement.className = 'shop-btn buy-btn';
                buttonElement.disabled = userData.points < item.price;
                buttonElement.textContent = '購買';
                buttonElement.onclick = () => {
                    if (purchaseItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`成功購買${item.name}！`, 'ai');
                    }
                };
            }
        } else {
            if (isOwned) {
                buttonElement.className = `shop-btn use-btn ${isActive ? 'active' : ''}`;
                buttonElement.textContent = isActive ? '使用中' : '使用';
                buttonElement.onclick = () => {
                    if (useItem(item.id, itemType)) {
                        renderShopItems(tab);
                        if (tab === 'personalities') {
                            addMessage(`已切換為${item.name}性格！`, 'ai');
                        }
                    }
                };
            } else {
                buttonElement.className = 'shop-btn buy-btn';
                buttonElement.disabled = userData.points < item.price;
                buttonElement.textContent = '購買';
                buttonElement.onclick = () => {
                    if (purchaseItem(item.id, itemType)) {
                        renderShopItems(tab);
                        addMessage(`成功購買${item.name}！`, 'ai');
                    }
                };
            }
        }
        
        itemDiv.appendChild(previewDiv);
if (!item.isHidden) {
    const giftIcon = document.createElement('i');
    giftIcon.className = 'fas fa-gift gift-icon';
    giftIcon.style.position = 'absolute';
    giftIcon.style.top = '5px';
    giftIcon.style.left = '5px';
    giftIcon.style.cursor = 'pointer';
    giftIcon.onclick = () => openGiftSendModal(item);
    itemDiv.appendChild(giftIcon);
}
itemDiv.appendChild(nameElement);
itemDiv.appendChild(priceElement);
itemDiv.appendChild(buttonElement);
shopItems.appendChild(itemDiv);
    });
}

        // 從列表中獲取一個隨機項目
        function getRandomItem(items) {
            if (items.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * items.length);
            return items[randomIndex];
        }

        // 從列表中獲取一個隨機未擁有的項目
        function getRandomUnownedItem(items, ownedItems) {
            // 過濾出未擁有的項目
            const unownedItems = items.filter(item => !ownedItems.includes(item.id));
            return getRandomItem(unownedItems);
        }

        // 創建紙屑效果
        function createConfetti() {
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff69b4'];
    const confettiCount = 150;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = `${Math.random() * 20}%`;
        confetti.style.width = `${Math.random() * 15 + 8}px`;
        confetti.style.height = `${Math.random() * 15 + 8}px`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        confetti.style.setProperty('--random-x', `${(Math.random() - 0.5) * 400}px`);
        confetti.style.animationDelay = `${Math.random() * 2}s`;
        confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
        confetti.style.zIndex = '10';
        
        // 添加3D旋轉效果
        const randomRotate = Math.random() * 360;
        confetti.style.transform = `rotateZ(${randomRotate}deg)`;
        
        mysteryboxAnimation.appendChild(confetti);
        
        // 動畫結束後移除紙屑元素
        setTimeout(() => {
            if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
            }
        }, 6000);
    }
}


        // 顯示通知
        function showNotification(text) {
            notificationText.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 商店和設置事件監聽
        shopButton.addEventListener('click', () => {
            shopModal.style.display = 'flex';
            renderShopItems('expressions');
        });

        settingsButton.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
            vtuberNameInput.value = '';  // 清空輸入框
            clearNameMessages();  // 清除之前的消息
        });

        closeShop.addEventListener('click', () => {
            shopModal.style.display = 'none';
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // 保存名稱按鈕事件
        saveNameBtn.addEventListener('click', () => {
            const newName = vtuberNameInput.value;
            setVtuberName(newName);
        });

        // 名稱輸入框回車事件
        vtuberNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const newName = vtuberNameInput.value;
                setVtuberName(newName);
            }
        });

        // 點擊模態框外部關閉
        window.addEventListener('click', (e) => {
            if (e.target === shopModal) {
                shopModal.style.display = 'none';
            }
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (e.target === mysteryboxAnimation) {
                // 不允許點擊關閉盲盒動畫
            }
        });

     // 商店標籤事件（包含動態添加的禮物標籤）
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab') && e.target.closest('.shop-tabs')) {
        // 移除所有商店標籤的active狀態
        e.target.closest('.shop-tabs').querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        renderShopItems(e.target.dataset.tab);
    }
});


        // VTUBER 嘴型動畫控制
        function startTalking() {
            if (!isTalking) {
                isTalking = true;
                vtuberMouth.classList.add('talking');
                vtuberContainer.style.transform = 'scale(1.1)';
                vtuberContainer.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.2)';
            }
        }

        function stopTalking() {
            if (isTalking) {
                isTalking = false;
                vtuberMouth.classList.remove('talking');
                vtuberContainer.style.transform = '';
                vtuberContainer.style.boxShadow = '';
            }
        }

        // 隨機眨眼動畫
        function randomBlinking() {
            const pupils = document.querySelectorAll('.vtuber-pupil');
            const randomTime = Math.floor(Math.random() * 4000) + 2000;
            
            setTimeout(() => {
                pupils.forEach(pupil => {
                    pupil.style.animation = 'blink 0.3s ease';
                    setTimeout(() => {
                        pupil.style.animation = '';
                        randomBlinking();
                    }, 300);
                });
            }, randomTime);
        }

        // 啟動隨機眨眼
        randomBlinking();

        // 檢查瀏覽器是否支援語音識別 - 修復語音輸入問題
        function isSpeechRecognitionSupported() {
            return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        }

        // 語音識別初始化 - 修復語音輸入問題
        function initSpeechRecognition() {
            if (!isSpeechRecognitionSupported()) {
                voiceBtn.disabled = true;
                voiceBtn.title = '您的瀏覽器不支援語音輸入';
                return null;
            }

            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.error('Speech recognition not supported');
                    voiceBtn.disabled = true;
                    voiceBtn.title = '您的瀏覽器不支援語音輸入';
                    return null;
                }

                const recognizer = new SpeechRecognition();
                recognizer.lang = 'zh-HK';
                recognizer.continuous = true;
                recognizer.interimResults = true;

                recognizer.onstart = function() {
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    recordingIndicator.style.display = 'flex';
                    swipeHint.style.display = 'block';
                    voiceBtn.title = '正在語音輸入，滑動取消';
                };

                recognizer.onresult = function(event) {
                    if (!event || !event.results) {
                        console.error('語音識別結果無效');
                        return;
                    }

                    clearTimeout(silenceTimeout);
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i] && event.results[i][0]) {
                            if (event.results[i].isFinal) {
                                transcript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                    }

                    // 防止輸入框延遲，使用requestAnimationFrame進行優化
                    requestAnimationFrame(() => {
                        userInput.value = transcript + interimTranscript;
                    });
                    
                    // 設置自動停止
                    silenceTimeout = setTimeout(() => {
                        try {
                            recognizer.stop();
                            sendMessage();
                        } catch (error) {
                            console.error('停止語音識別出錯:', error);
                            stopRecording();
                        }
                    }, 2000);
                };

                recognizer.onerror = function(event) {
                    console.error('語音識別錯誤:', event.error);
                    addMessage(`語音輸入出錯: ${event.error}`, 'error');
                    stopRecording();
                };

                recognizer.onend = function() {
                    stopRecording();
                };

                return recognizer;
            } catch (error) {
                console.error('初始化語音識別失敗:', error);
                voiceBtn.disabled = true;
                voiceBtn.title = '語音輸入初始化失敗';
                return null;
            }
        }

        // 初始化語音識別
        recognition = initSpeechRecognition();

        // 開始錄音
        function startRecording() {
            if (!recognition) {
                addMessage('語音識別功能未能初始化', 'error');
                return;
            }
            
            if (voiceBtn.disabled) return;
            
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                stopTalking();
            }
            
            try {
                transcript = '';
                recognition.start();
            } catch (error) {
                console.error('啟動語音識別失敗:', error);
                
                // 嘗試重新初始化語音識別
                recognition = initSpeechRecognition();
                if (recognition) {
                    setTimeout(() => {
                        try {
                            transcript = '';
                            recognition.start();
                        } catch (retryError) {
                            console.error('重試啟動語音識別失敗:', retryError);
                            addMessage('啟動麥克風失敗，請確保已授予權限', 'error');
                            stopRecording();
                        }
                    }, 500);
                } else {
                    addMessage('啟動麥克風失敗，請確保已授予權限', 'error');
                    stopRecording();
                }
            }
        }

        // 停止錄音
        function stopRecording() {
            isRecording = false;
            voiceBtn.classList.remove('recording');
            recordingIndicator.style.display = 'none';
            swipeHint.style.display = 'none';
            voiceBtn.title = '點擊語音輸入';
            voiceBtn.disabled = false;
            clearTimeout(silenceTimeout);
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('停止語音識別時出錯:', error);
                }
            }
        }

        // 檢查滑動取消
        function checkSwipe(e) {
            if (!isRecording) return;
            
            let currentX, currentY;
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            } else {
                currentX = e.clientX;
                currentY = e.clientY;
            }
            
            const deltaX = Math.abs(currentX - touchStartX);
            const deltaY = Math.abs(currentY - touchStartY);
            
            if (deltaX > SWIPE_THRESHOLD || deltaY > SWIPE_THRESHOLD) {
                if (recognition) {
                    try {
                        recognition.stop();
                    } catch (error) {
                        console.error('滑動取消時停止語音識別出錯:', error);
                    }
                }
                addMessage('語音輸入已取消', 'error');
                stopRecording();
            }
        }

        // 語音合成 - 修復版本
        function speak(text) {
            if ('speechSynthesis' in window && ttsAutoPlay.checked) {
                try {
                    speechSynthesis.cancel();
                    stopTalking();
                    
                    // 徹底清理文本格式
                    let cleanedText = cleanText(text);
                    
                    // 額外清理特殊符號和括號內容
                    cleanedText = cleanedText
                        .replace(/\([^)]*\)/g, '') // 移除括號內容
                        .replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2700}-\u{27BF}]/gu, '') // 移除emoji
                        .replace(/[^\u4e00-\u9fff\u3400-\u4dbf\u20000-\u2a6df\u2a700-\u2b73f\u2b740-\u2b81f\u2b820-\u2ceaf\u2ceb0-\u2ebe0。，、；：？！""''（）〔〕【】《》〈〉…—\s]/g, '') // 只保留中文、標點符號和空格
                        .trim();
                    
                    if (!cleanedText) return;
                    
                    const sentences = cleanedText.split(/(?<=[。！？])/);
                    
                    let currentIndex = 0;
                    
                    function speakNext() {
                        if (currentIndex >= sentences.length) {
                            stopTalking();
                            return;
                        }
                        
                        const sentence = sentences[currentIndex].trim();
                        if (sentence) {
                            const utterance = new SpeechSynthesisUtterance(sentence);
                            utterance.lang = 'zh-HK';
                            utterance.rate = 1.05;
                            utterance.pitch = 0.3;
                            
                            utterance.onstart = function() {
                                startTalking();
                            };
                            
                            utterance.onend = function() {
                                currentIndex++;
                                speakNext();
                            };
                            
                            utterance.onerror = function(e) {
                                console.error('語音合成錯誤:', e);
                                stopTalking();
                                currentIndex++;
                                setTimeout(speakNext, 500);
                            };
                            
                            try {
                                speechSynthesis.speak(utterance);
                            } catch (error) {
                                console.error('語音合成發生錯誤:', error);
                                stopTalking();
                                currentIndex++;
                                setTimeout(speakNext, 500);
                            }
                        } else {
                            currentIndex++;
                            speakNext();
                        }
                    }
                    
                    speakNext();
                } catch (error) {
                    console.error('語音合成初始化錯誤:', error);
                    stopTalking();
                }
            }
        }

        // 添加消息到聊天
        function addMessage(content, role) {
            // 清理內容中的思考標籤和格式符號
            if (role === 'ai') {
                content = cleanText(content);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'ai' ? 'ai-message' : role === 'user' ? 'user-message' : 'error-message'}`;

            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
                messageHeader.innerHTML = `
        <i class="fas ${role === 'ai' ? 'fa-robot' : 'fa-user'}"></i>
        <span>${role === 'ai' ? (userData.vtuberName || '史萊姆') : '你'}</span>
    `;


            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            if (role === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.title = '複製回應';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(content);
                    copyBtn.classList.add('copied');
                    setTimeout(() => copyBtn.classList.remove('copied'), 2000);
                });
                messageActions.appendChild(copyBtn);
            }

            messageDiv.appendChild(messageHeader);
            messageDiv.appendChild(messageContent);
            if (role === 'ai') messageDiv.appendChild(messageActions);
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        // 更新所有AI消息的顯示名稱
function updateAllAIMessageNames() {
    const aiMessages = document.querySelectorAll('.ai-message .message-header span');
    aiMessages.forEach(span => {
        if (span.textContent !== '你') {
            span.textContent = userData.vtuberName || '史萊姆';
        }
    });
}

        // 發送消息到API
        async function sendMessage() {
            let message = userInput.value.trim();
            if (!message) return;

            message = message
                .replace(/(呢|呀|啦|喎|咁|同埋)$/g, '$1。')
                .replace(/(係|唔係|有|無|咪|係咪)$/g, '$1，')
                .replace(/(因為|所以|如果|但係)$/g, '$1，')
                .replace(/([。！？])([^\s])/g, '$1 $2')
                .trim();

            addMessage(message, 'user');
            userInput.value = '';
            sendBtn.disabled = true;
            voiceBtn.disabled = true;
            typingIndicator.style.display = 'block';

            conversationHistory.push({ role: 'user', content: message });

            try {
                speechSynthesis.cancel();
                stopTalking();

                const mode = modeSelect.value;
                const currentPersonality = personalities.find(p => p.id === userData.currentPersonality);
                let personalityPrompt = currentPersonality && currentPersonality.prompt ? currentPersonality.prompt : '';
                
                let systemPrompt = '';
                if (mode === 'comfort') {
                    systemPrompt = `你是一個中學DSE高中世界歷史科老師，專門負責香港DSE（香港中學文憑考試）世界歷史科的教學與答疑。必須用繁體中文及香港粵語回應，你的形象較正經嚴肅，但用語仍然傾向生活化，回應求力準確。

知識範圍
你的專業知識涵蓋以下課程內容：

必修部分（約210小時）
引言：現代世界的基礎（約10小時）
介紹塑造當代世界的主要歷史力量。
主題甲：二十世紀亞洲的現代化與轉變（約100小時）
香港的現代化與轉變（約30小時）
政治及行政的轉變：主要發展趨勢、不同階段的特點。
國際城市的發展：經濟發展、城市化與人口變遷、中外文化的共存與相互影響、與內地的關係及在亞太地區的角色。
中國的現代化與轉變（約40小時）
早期現代化努力：清末新政、辛亥革命、五四運動、南京政府的現代化努力、共產主義革命與中華人民共和國的成立。
毛澤東時代及後毛澤東時代：政治體制轉變、毛澤東時代的現代化措施（五年計劃、大躍進等）、文化大革命的影響、1978年後的改革開放及「有中國特色的社會主義」的發展。
日本及東南亞的現代化與轉變（約30小時）
日本及東南亞地區（具體內容依大綱說明）的現代化過程與特點。
主題乙：二十世紀世界的衝突與合作（約100小時）
主要衝突與和平的追求（約60小時）
1900-1914年的國際關係：歐洲列強關係、戰爭與衝突的起因、爭取和平的努力。
兩次世界大戰及相關和約：巴黎和會、第二次世界大戰後安排及其影響，戰爭的政治、社會、經濟、文化意義。
第一次世界大戰後的衝突與和平努力：
超級大國對抗與緩和：冷戰的成因與發展、美蘇關係緩和、蘇聯及華沙公約解體。
其他衝突：以色列與阿拉伯國家的衝突、巴爾幹半島種族衝突、南非種族隔離，聯合國在維持和平中的角色。
合作與繁榮（約40小時）
經濟合作：二戰後歐洲重建與經濟統合、美國與蘇聯的角色、歐洲經濟統合的趨勢與意義。
社會與文化合作：人口與資源、環境保育、科學與技術的發展與局限。
選修部分（約40小時，學生選其一）
比較歷史
探討相關歷史現象在不同地區的發展，或某地區長期歷史的轉變與延續，找出共同點與特殊性。
歷史議題探究
研究重要社會或全球性議題的根源與發展，分析爭議並作出合理判斷。
本地文化承傳研究
探究與香港本地歷史及文化承傳相關的課題，應用多種研習方式。
角色與任務
你的角色是協助學生理解DSE世界歷史科的內容，並回答他們的問題。你應能夠：

提供詳盡資訊：關於具體歷史事件、人物、發展的因果關係及其意義。
解釋概念與方法：如因果關係、歷史變遷與延續、歷史詮釋等。
協助史料分析：幫助學生評估primary和secondary史料的可靠性與偏見。
指導作文技巧：教導歷史作文的結構、論證方法及證據運用。
提供考試建議：針對DSE世界歷史考試，指導應試技巧及題型應對策略。
多角度討論：從不同視角探討歷史事件，並進行比較與對照。
闡述史學爭議：如課程涉及的歷史詮釋或爭論，加以解釋。
給予學習建議：提供與課程相關的學習技巧或進階資源建議。
回答風格
清晰簡潔：用適合高中生的語言表達，避免過於複雜的術語。
鼓勵耐心：態度友善，願意進一步澄清問題，促進學生理解。
區域關聯：盡可能使用與亞太地區或香港相關的例子，使內容更貼近學生經驗。
限制與要求
範圍限定：僅回答與DSE世界歷史課程大綱（第13-19頁）相關的問題，不涉及大綱外的內容。
事實為本：依據歷史事實及學界認可的詮釋，避免臆測或個人意見。
超出範圍處理：若問題超出課程範圍，禮貌告知：「這個問題不在DSE世界歷史課程大綱（第13-19頁）的範圍內，建議你參考其他資源。」
示例應用
當學生問及「冷戰的成因是什麼？」時，你應根據主題乙「主要衝突與和平的追求」中的內容，詳細說明冷戰的起源（如美蘇意識形態對立、二戰後權力真空等），並適當提及亞太地區的相關影響（如中國角色），保持回答與課程目標一致。${personalityPrompt} 

重要規則：你的回應必須是純淨的文字格式，絕對不可以包含任何格式符號，包括但不限於：
- 絕對不可以使用星號，如「**文字**」或「*文字*」
- 絕對不可以使用斜線，如「/文字/」
- 絕對不可以使用井號、反引號、方括號等格式符號
- 絕對不可以使用任何markdown格式
- 絕對不可以顯示思考過程，如「<think></think>」內容
- 絕對不可以用括號來表述額外說明
- 絕對不可以用阿拉伯列點，如「1.」（要改為「第一，」、「2.」（要改為第二，」

你的回應只能包含：中文文字、中文標點符號（。，、！？：；""''）、數字、emoji表情符號。你的回應絕對不可以超過一百五十字。

絕對不可以用粗言穢語或粗口諧音，嚴禁用「屌」、「撚」、「仆街」！`;
                } else {
                    systemPrompt = `你是一個中學DSE高中中國歷史科老師，專門負責香港DSE（香港中學文憑考試）中界歷史科的教學與答疑。必須用繁體中文及香港粵語回應，你的形象較正經嚴肅，但用語仍然傾向生活化，回應求力準確。

知識範圍
你的專業知識涵蓋以下課程內容：

必修部分（歷代發展）
上古至十九世紀中葉
夏商周時期
周代分封：西周初年的分封制度如何開拓疆土、鞏固周天子地位，並影響民族融合。
春秋戰國的政治與社會變動：平王東遷後周室衰微，春秋時期諸侯爭霸與戰國時期的兼併戰爭，社會形態轉型（平民崛起、工商業發展、知識階層興起）。
秦漢時期
秦漢的統治政策：秦的中央集權（郡縣制、法律統一）、漢的文景之治與武帝的政策（儒家獨尊、開拓邊疆）。
秦漢的社會經濟：農業發展（如鐵器使用）、商業興盛（如絲綢之路）、社會階層變動。
魏晉南北朝時期
政治動盪與民族融合：三國鼎立、南北對峙、北方民族內遷與融合。
宗教與思想的發展：佛教傳入與發展、道教興起、玄學盛行。
隋唐時期
政治制度與社會變遷：隋唐的科舉制、三省六部制、均田制與租庸調制，社會流動性增強。
文化與科技的發展：唐詩盛世、印刷術進步、與外族的交流（如長安的國際化）。
宋元明清時期
政治制度的演變：宋的中央集權強化、元的行省制、明的內閣制、清的軍機處與文字獄。
經濟與社會的發展：宋的商品經濟、元的農業與手工業、明的海上貿易、清的閉關鎖國與人口增長。
文化與思想的變遷：宋的理學、明的實學、滿清的考證學與西學東漸。
十九世紀中葉至二十世紀末
鴉片戰爭至辛亥革命
列強侵略與中國的反應：鴉片戰爭、太平天國、洋務運動、戊戌變法、清末新政。
社會經濟的變遷：傳統經濟解體、近代工業萌芽、農村破產與城市化。
民國時期
政治動盪與軍閥混戰：北洋政府分裂、軍閥割據、五四運動與新文化運動。
國共合作與分裂：第一次國共合作、抗戰前國共對峙。
抗日戰爭與解放戰爭
日本侵華與中國的抵抗：九一八事變、七七事變、抗戰中的民族團結與國際援助。
國共內戰與新中國的成立：解放戰爭的經過、中華人民共和國建立的意義。
中華人民共和國時期
政治制度的建立與演變：社會主義制度的確立、毛澤東時代的集權、改革開放後的調整。
經濟建設與社會變革：土地改革、三大改造、大躍進、文革、改革開放的經濟成就。
文化大革命與改革開放：文革對文化與社會的衝擊、改革開放後的思想解放與文化復甦。
選修部分（歷史專題，學生選其一）
二十世紀中國傳統文化的發展：承傳與變遷
新文化運動、五四運動、社會主義文化建設對傳統文化的影響與轉型。
地域與資源運用
黃河、長江、運河等地域資源如何影響經濟與社會發展。
時代與知識分子
不同時代知識分子的角色（如孔子、司馬遷、王安石、梁啟超）及其影響。
制度與政治演變
土地制度（如均田制）、兵制（如府兵制）、科舉制的演變與影響。
宗教傳播與文化交流
佛教、道教、伊斯蘭教、基督教在中國的傳播及其文化交融。
女性社會地位：傳統與變遷
傳統社會中女性的角色、近代女權運動與地位提升。
歷史研習的態度與方法
培養正確的歷史觀：理解歷史的延續與變遷。
史料分析：辨別史料的真偽與偏見，運用一手與二手史料。
批判性思維：多角度分析歷史事件，獨立判斷與探究。
角色與任務
你的角色是協助學生理解DSE中國歷史科的內容，並回答他們的問題。你應能夠：

提供詳盡資訊：關於具體歷史事件、人物、發展的因果關係及其意義（如秦漢統治政策的影響）。
解釋概念與方法：如因果關係（鴉片戰爭導致中國近代化）、歷史變遷與延續（科舉制的演變）、歷史詮釋（對文革的不同評價）。
協助史料分析：幫助學生評估史料的可靠性與偏見（如太平天國史料的立場分析）。
指導作文技巧：教導歷史作文的結構（引言、論點、結論）、論證方法及證據運用。
提供考試建議：針對DSE中國歷史考試，指導應試技巧（如時間分配、史料題解題步驟）及題型應對策略。
多角度討論：從不同視角探討歷史事件（如洋務運動的成功與局限），並進行比較與對照。
闡述史學爭議：如課程涉及的歷史詮釋或爭論（如辛亥革命的歷史地位），加以解釋。
給予學習建議：提供與課程相關的學習技巧（如製作時間線）或進階資源建議（如參考《中國通史》）。
回答風格
清晰簡潔：用適合高中生的語言表達，避免過於複雜的術語（如用「中央集權」而非「集權主義」）。
鼓勵耐心：態度友善，願意進一步澄清問題，促進學生理解。
區域關聯：盡可能使用與香港或華南地區相關的例子（如清末新政對香港的影響），使內容更貼近學生經驗。
限制與要求
範圍限定：僅回答與DSE中國歷史課程大綱（第19-42頁）相關的問題，不涉及大綱外的內容。
事實為本：依據歷史事實及學界認可的詮釋，避免臆測或個人意見。
超出範圍處理：若問題超出課程範圍，禮貌告知：「這個問題不在DSE中國歷史課程大綱（第19-42頁）的範圍內，建議你參考其他資源。」
示例應用
問題：「秦漢的統治政策有哪些特點？」
回答：根據必修部分「秦漢時期」的內容，秦漢的統治政策以中央集權為核心。秦始皇建立郡縣制，廢除分封，統一法律、文字與度量衡，強化皇帝權力；漢朝承襲此制，漢武帝推行儒家獨尊，削弱地方勢力，並設立刺史監察地方。這些政策奠定了中國封建制度的基礎，對後世影響深遠，例如中央集權模式一直延續至清朝。
問題：「二十世紀中國傳統文化的發展有哪些變化？」
回答：根據選修部分「二十世紀中國傳統文化的發展」，五四運動推動新文化運動，反對儒家傳統，提倡白話文與科學民主；中共建國後，社會主義文化取代舊文化，文革期間傳統文化受嚴重破壞；改革開放後，傳統文化（如儒學）逐漸復興，並與現代化融合，形成承傳與變遷並存的局面。
問題：「如何準備DSE中國歷史考試？」
回答：建議熟悉課程大綱中的必修與選修內容，製作歷史時間線梳理事件脈絡；練習史料題時，先辨別史料來源與立場，再結合背景知識回答；作文要列提綱，確保論點清晰並引用史實。平時多做過去試題，掌握時間分配，如每題控制在20-25分鐘內完成。${personalityPrompt} 

重要規則：你的回應必須是純淨的文字格式，絕對不可以包含任何格式符號，包括但不限於：
- 絕對不可以使用星號，如「**文字**」或「*文字*」
- 絕對不可以使用斜線，如「/文字/」
- 絕對不可以使用井號、反引號、方括號等格式符號
- 絕對不可以使用任何markdown格式
- 絕對不可以顯示思考過程，如「<think></think>」內容
- 絕對不可以用括號來表述額外說明
- 絕對不可以用阿拉伯列點，如「1.」（要改為「第一，」、「2.」（要改為第二，」

你的回應只能包含：中文文字、中文標點符號（。，、！？：；""''）、數字、emoji表情符號。你的回應絕對不可以超過一百五十字。

絕對不可以用粗言穢語或粗口諧音，嚴禁用「屌」、「撚」、「仆街」！`;
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEYS[currentApiKeyIndex]}`
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...conversationHistory
                        ],
                        max_tokens: 64000
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 && currentApiKeyIndex < API_KEYS.length - 1) {
                        currentApiKeyIndex++;
                        addMessage('API 限制，切換密鑰重試...', 'ai');
                        sendMessage();
                        return;
                    }
                    throw new Error(`HTTP 錯誤！狀態：${response.status}`);
                }

                const data = await response.json();
                let aiResponse = data.choices[0].message.content;
                
                // 徹底清理AI回應
                aiResponse = cleanText(aiResponse);
                
                addMessage(aiResponse, 'ai');
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                
                addPoints(1);
                speak(aiResponse);
            } catch (error) {
                addMessage(`錯誤：${error.message}`, 'error');
            }

            typingIndicator.style.display = 'none';
            sendBtn.disabled = false;
            voiceBtn.disabled = false;
        }

        // 流暢拖拽實現
        let dragOffset = { x: 0, y: 0 };
        let dragStartPos = { x: 0, y: 0 };

        function handleDragStart(e) {
            e.preventDefault();
            isDragging = true;
            dragStartTime = Date.now();
            
            const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            const rect = vtuberContainer.getBoundingClientRect();
            
            dragOffset.x = clientX - rect.left;
            dragOffset.y = clientY - rect.top;
            dragStartPos.x = clientX;
            dragStartPos.y = clientY;
            
            vtuberContainer.style.cursor = 'grabbing';
            vtuberContainer.style.transition = 'none';
            
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            requestAnimationFrame(() => {
                const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
                const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                
                const x = clientX - dragOffset.x;
                const y = clientY - dragOffset.y;
                
                const maxX = window.innerWidth - vtuberContainer.offsetWidth;
                const maxY = window.innerHeight - vtuberContainer.offsetHeight;
                
                const boundedX = Math.max(0, Math.min(x, maxX));
                const boundedY = Math.max(0, Math.min(y, maxY));
                
                vtuberContainer.style.right = 'auto';
                vtuberContainer.style.bottom = 'auto';
                vtuberContainer.style.left = `${boundedX}px`;
                vtuberContainer.style.top = `${boundedY}px`;
            });
        }

        function handleDragEnd() {
            isDragging = false;
            vtuberContainer.style.cursor = 'grab';
            vtuberContainer.style.transition = 'all 0.3s ease';
            
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', handleDragEnd);
            document.removeEventListener('touchmove', handleDragMove);
            document.removeEventListener('touchend', handleDragEnd);
            
            // 檢查是否是點擊而不是拖拽
            const dragTime = Date.now() - dragStartTime;
            if (dragTime < 200) {
                // 這是一個點擊，可以添加點擊事件處理
            }
        }

        // 事件監聽器
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) sendMessage();
        });

        voiceBtn.addEventListener('click', () => {
            if (!isRecording && recognition) {
                startRecording();
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (isRecording && e.touches.length > 0) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }
        });

        document.addEventListener('touchmove', checkSwipe);
        document.addEventListener('touchend', () => {
            if (isRecording) {
                // 結束錄音處理
            }
        });

        // 設置VTUBER拖拽事件
        vtuberContainer.addEventListener('mousedown', handleDragStart);
        vtuberContainer.addEventListener('touchstart', handleDragStart);

        // 替換現有的DOMContentLoaded事件
document.addEventListener('DOMContentLoaded', () => {
    // 檢查用戶登入狀態
   auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        loadUserProfile();
        showMainInterface();
        initUserData();
        
        // 原有的問候語代碼
        const greetings = [
            "最近你又好似變蠢咗咁。點啊？有咩分享呀？",
            "喂，你今日心情點呀？唔好話我知你又喺度發呆呀。",
            "哎呀，你又嚟啦。準備好俾我笑未？",
            "哇！你個樣殘到咁，一定係尋晚掛住煲劇。",
            "係唔係地球重力突然加大？你個頭耷到貼地喎。",
            "今日你個髮型好有創意喎，係咪用咗電飯煲剪頭髮呀你？",
            "喂！你件衫同我阿婆張梳化撞款喎，復古大師？",
            "睇你個樣似被外星人綁架完放返嚟，分享下經歷啦！",
            "你對眼瞇到得條線，尋晚去咗做賊啊？",
            "你個樣似食咗安眠藥但仲要返工，堅強呀兄弟！",
            "今日你個氣場好特別，似足茶餐廳杯凍檸茶——少甜走冰。",
            "你個樣愁過考試肥佬，係咪便秘咗三日呀？",
            "你個頭油到反光，可以借嚟當鏡照啦！",
            "今日你個氣場頹過淋雨嘅流浪貓，需要熱牛奶嗎？",
            "你件外套似我屋企張梳化套，有冇親戚關係㗎？",
            "你個笑容僵過蠟像館展品，需要幫你解凍嗎？",
            "成個人霉過回南天，你需要抽濕機定太陽燈呀？",
            "你成身散發咖啡因氣息，今日第幾杯呀？",
            "你成個人散發怨氣，係撞鬼定撞見老細？",
            "你個眼袋深過馬里亞納海溝呀，真係嚇死人。",
            "你個樣呆過未插電嘅機械人，需要充電嗎？"
        ];
        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
        addMessage(randomGreeting, 'ai');
conversationHistory.push({ role: 'assistant', content: randomGreeting });

// 延遲播放TTS，等待用戶首次互動
setTimeout(() => {
    if (ttsAutoPlay.checked) {
        // 嘗試播放，如果失敗則提示用戶點擊
        const testUtterance = new SpeechSynthesisUtterance('');
        testUtterance.volume = 0;
        speechSynthesis.speak(testUtterance);
        
        testUtterance.onstart = () => {
            speak(randomGreeting);
        };
        
        testUtterance.onerror = () => {
            // 如果自動播放失敗，顯示提示
            const playBtn = document.createElement('button');
            playBtn.style.cssText = `
                position: fixed;
                top: 120px;
                right: 20px;
                background: #4a90e2;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 25px;
                cursor: pointer;
                z-index: 1000;
                font-size: 0.9rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            playBtn.onclick = () => {
                speak(randomGreeting);
                playBtn.remove();
            };
            document.body.appendChild(playBtn);
            
            setTimeout(() => {
                if (playBtn.parentNode) playBtn.remove();
            }, 10000);
        };
    }
}, 1000);

        
        if (!isSpeechRecognitionSupported()) {
            addMessage("提示：您的瀏覽器不支援語音輸入功能，請使用最新版Chrome或Edge瀏覽器", 'error');
        }
    } else {
        showAuthInterface();
    }
});

    
    initAuthEvents();
    initFriendsEvents();
});

        // 開發者工具：調整飽腹值衰減速度
        // 在瀏覽器控制台中使用以下命令進行測試：
        // 修改衰減係數: HUNGER_DECAY_RATE = 0.1 (每24小時減10%)
        // 快速測試: userData.lastFeedTime = Date.now() - 86400000; updateHungerLevel(); (模擬24小時前)
        console.log('開發者工具提示：');
        console.log('修改飽腹值衰減係數: HUNGER_DECAY_RATE = 0.1 (每24小時減10%)');
        console.log('快速測試飢餓: userData.lastFeedTime = Date.now() - 86400000; updateHungerLevel();');
        console.log('重置飽腹值: userData.hungerLevel = 100; updateHungerDisplay(); updateVtuberAppearance();');
        console.log('測試名稱功能: setVtuberName("新名稱");');
        console.log('文本清理修復已完成！現在所有輸出都將是純淨格式。');


// 認證相關函數
function showAuthInterface() {
    authContainer.style.display = 'flex';
    document.querySelector('.top-controls').style.display = 'none';
    document.getElementById('chat-container').style.display = 'none';
    document.querySelector('.vtuber-container').style.display = 'none';
}

function showMainInterface() {
    authContainer.style.display = 'none';
    document.querySelector('.top-controls').style.display = 'flex';
    document.getElementById('chat-container').style.display = 'flex';
    document.querySelector('.vtuber-container').style.display = 'flex';
}

function initAuthEvents() {
    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
    });
    
    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
    });
    
    loginBtn.addEventListener('click', () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        auth.signInWithEmailAndPassword(email, password)
            .catch((error) => {
                alert('登入失敗: ' + error.message);
            });
    });
    
    registerBtn.addEventListener('click', () => {
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const characterName = document.getElementById('register-character-name').value.trim();
    
    // 處理角色名稱，如果沒有以「蛋」結尾則自動添加
    let finalCharacterName = characterName || email.split('@')[0];
    if (!finalCharacterName.endsWith("蛋")) {
        finalCharacterName = finalCharacterName + "蛋";
    }
    
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // 創建用戶資料
            return database.ref('users/' + userCredential.user.uid).set({
                characterName: finalCharacterName,
                email: email,
                avatar: finalCharacterName.charAt(0).toUpperCase(),
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        })
            .catch((error) => {
                alert('註冊失敗: ' + error.message);
            });
    });
    
   logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
        userData = {
            points: 20,
            purchasedExpressions: ['default'],
            purchasedHairstyles: ['default'],
            purchasedFoods: [],
            purchasedPersonalities: ['default'],
            currentExpression: 'default',
            currentHairstyle: 'default',
            currentPersonality: 'default',
            hungerLevel: 100,
            lastFeedTime: Date.now(),
            vtuberName: '史萊姆',
            hiddenCodesUsed: [],
            freeMysteryboxDraws: {}
        };
        showAuthInterface();
    }).catch((error) => {
        console.error('登出失敗:', error);
        addMessage('登出失敗，請重試', 'error');
    });
});

}

function loadUserProfile() {
    database.ref('users/' + currentUser.uid).once('value')
        .then((snapshot) => {
            userProfile = snapshot.val();
            if (!userProfile) {
                // 如果沒有用戶資料，創建默認資料
                let defaultName = currentUser.email.split('@')[0];
                if (!defaultName.endsWith("蛋")) {
                    defaultName = defaultName + "蛋";
                }
                userProfile = {
                    characterName: defaultName,
                    email: currentUser.email,
                    avatar: defaultName.charAt(0).toUpperCase()
                };
                database.ref('users/' + currentUser.uid).set(userProfile);
            }
            
            // 同步角色名稱到本地userData

            if (userProfile.characterName) {
                userData.vtuberName = userProfile.characterName;

// 同步VTUBER外觀設置
if (userProfile.vtuberAppearance) {
    userData.currentExpression = userProfile.vtuberAppearance.currentExpression || 'default';
    userData.currentHairstyle = userProfile.vtuberAppearance.currentHairstyle || 'default';
} else {
    userData.currentExpression = 'default';
    userData.currentHairstyle = 'default';
}

                updateVtuberName();
                saveUserData();
            }
        });
}

function checkNewGifts() {
    database.ref('users/' + currentUser.uid + '/gifts').on('child_added', (snapshot) => {
        const notification = document.getElementById('gift-notification');
        notification.style.display = 'block';
    });
}

auth.onAuthStateChanged((user) => {
    if (user) {
        checkNewGifts();
    }
});





function showGiftNotification() {
    const notification = document.getElementById('gift-notification');
    notification.style.display = 'block';
    setTimeout(() => {
        notification.style.display = 'none';
    }, 5000);
}

function closeGiftNotification() {
    document.getElementById('gift-notification').style.display = 'none';
}



// 好友系統函數
function initFriendsEvents() {
    friendsButton.addEventListener('click', () => {
        friendsModal.style.display = 'flex';
        loadFriendsList();
    });
    
    closeFriends.addEventListener('click', () => {
        friendsModal.style.display = 'none';
    });
    
    friendsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            friendsTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            document.querySelectorAll('.friends-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tab.dataset.tab).style.display = 'block';
            
            if (tab.dataset.tab === 'friends-list') {
                loadFriendsList();
            } else if (tab.dataset.tab === 'friend-requests') {
                loadFriendRequests();
            }
        });
    });
    
    document.getElementById('send-friend-request').addEventListener('click', sendFriendRequest);
    document.getElementById('friend-email').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendFriendRequest();
        }
    });
}

function sendFriendRequest() {
    const email = document.getElementById('friend-email').value.trim();
    if (!email) {
        alert('請輸入電子郵件地址');
        return;
    }
    
    // 根據email查找用戶
    database.ref('users').orderByChild('email').equalTo(email).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const userData = Object.entries(snapshot.val())[0];
                const friendId = userData[0];
                
                if (friendId === currentUser.uid) {
                    alert('不能添加自己為好友');
                    return;
                }
                
                // 檢查是否已經是好友
                return database.ref('friends/' + currentUser.uid + '/' + friendId).once('value');
            } else {
                throw new Error('找不到此電子郵件的用戶');
            }
        })
        .then((friendSnapshot) => {
            if (friendSnapshot.exists()) {
                alert('該用戶已經是您的好友');
                return;
            }
            
            // 檢查是否已經發送過申請
            return database.ref('friendRequests').orderByChild('from').equalTo(currentUser.uid).once('value');
        })
        .then((requestsSnapshot) => {
            if (requestsSnapshot.exists()) {
                const requests = requestsSnapshot.val();
                const userData = Object.entries(database.ref('users').orderByChild('email').equalTo(document.getElementById('friend-email').value.trim()))[0];
                const friendId = userData ? userData[0] : null;
                
                const existingRequest = Object.values(requests).find(req => 
                    req.to === friendId && req.status === 'pending'
                );
                
                if (existingRequest) {
                    alert('已經向該用戶發送過好友申請');
                    return;
                }
            }
            
            // 重新獲取朋友ID用於發送申請
            return database.ref('users').orderByChild('email').equalTo(document.getElementById('friend-email').value.trim()).once('value');
        })
        .then((snapshot) => {
            if (snapshot && snapshot.exists()) {
                const userData = Object.entries(snapshot.val())[0];
                const friendId = userData[0];
                
                // 發送好友申請
                const requestData = {
                    from: currentUser.uid,
                    to: friendId,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                return database.ref('friendRequests').push(requestData);
            }
        })
        .then(() => {
            alert('好友申請已發送');
            document.getElementById('friend-email').value = '';
        })
        .catch((error) => {
            console.error('發送好友申請失敗:', error);
            alert('發送好友申請失敗: ' + error.message);
        });
}

function loadFriendsList() {
    const container = document.getElementById('friends-list-container');
    container.innerHTML = '';
    
    database.ref('friends/' + currentUser.uid).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const friends = snapshot.val();
                Object.keys(friends).forEach(friendId => {
                    loadFriendInfo(friendId, container);
                });
            } else {
                container.innerHTML = '<p>還沒有好友，快去添加吧！</p>';
            }
        });
}

function loadFriendInfo(friendId, container) {
    const friendRef = database.ref('users/' + friendId);
    friendRef.on('value', (snapshot) => {
        const friendData = snapshot.val();
        if (friendData) {
            const appearance = friendData.vtuberAppearance || {
                currentExpression: 'default',
                currentHairstyle: 'default'
            };
            updateFriendAvatar(friendId, appearance, container);
        }
    });
}

function updateFriendAvatar(friendId, appearance, container, isRequest = false, requestId = null) {
    let friendItem = container.querySelector(`[data-friend-id="${friendId}"]`);
    if (!friendItem) {
        friendItem = document.createElement('div');
        friendItem.className = 'friend-item';
        friendItem.dataset.friendId = friendId;
        container.appendChild(friendItem);
    }

    friendItem.innerHTML = '';
    const avatarElement = createVtuberAvatar(appearance, 50);
    avatarElement.className = 'friend-avatar';
    avatarElement.style.marginRight = '15px';

    database.ref('users/' + friendId).once('value').then((snapshot) => {
        const friendData = snapshot.val();
        const infoDiv = document.createElement('div');
        infoDiv.className = 'friend-info';
        infoDiv.innerHTML = `
            <div><strong>${friendData.characterName || friendData.username || '未命名'}</strong></div>
            <div>${friendData.email}</div>
        `;

        const actionsDiv = document.createElement('div');
    actionsDiv.className = 'friend-actions';
    if (isRequest) {
        actionsDiv.innerHTML = `
    <button class="accept-btn" onclick="acceptFriendRequest('${requestId}', '${friendId}')">
        <i class="fas fa-check"></i>
    </button>
    <button class="reject-btn" onclick="rejectFriendRequest('${requestId}')">
        <i class="fas fa-times"></i>
    </button>
        `;
    } else {
       actionsDiv.innerHTML = '';
    }

        friendItem.appendChild(avatarElement);
        friendItem.appendChild(infoDiv);
        friendItem.appendChild(actionsDiv);
    });
}

function loadFriendRequests() {
    const container = document.getElementById('friend-requests-container');
    container.innerHTML = '';
    
    database.ref('friendRequests').orderByChild('to').equalTo(currentUser.uid).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const requests = snapshot.val();
                Object.entries(requests).forEach(([requestId, request]) => {
                    if (request.status === 'pending') {
                        loadRequestInfo(requestId, request, container);
                    }
                });
            } else {
                container.innerHTML = '<p>沒有待處理的好友申請</p>';
            }
        });
}

function loadRequestInfo(requestId, request, container) {
    const userRef = database.ref('users/' + request.from);
    userRef.on('value', (snapshot) => {
        const userData = snapshot.val();
        if (userData) {
            const appearance = userData.vtuberAppearance || {
                currentExpression: 'default',
                currentHairstyle: 'default'
            };
            updateFriendAvatar(request.from, appearance, container, true, requestId);
        }
    });
}

function acceptFriendRequest(requestId, friendId) {
    // 更新好友申請狀態
    database.ref('friendRequests/' + requestId).update({ status: 'accepted' })
        .then(() => {
            // 添加雙向好友關係
            const updates = {};
            updates['friends/' + currentUser.uid + '/' + friendId] = true;
            updates['friends/' + friendId + '/' + currentUser.uid] = true;
            
            return database.ref().update(updates);
        })
        .then(() => {
            alert('已接受好友申請');
            loadFriendRequests();
            loadFriendsList(); // 添加這一行來刷新好友列表
        })
        .catch((error) => {
            console.error('接受好友申請失敗:', error);
            alert('操作失敗: ' + error.message);
        });
}


function rejectFriendRequest(requestId) {
    database.ref('friendRequests/' + requestId).update({ status: 'rejected' })
        .then(() => {
            alert('已拒絕好友申請');
            loadFriendRequests();
        })
        .catch((error) => {
            console.error('拒絕好友申請失敗:', error);
            alert('操作失敗: ' + error.message);
        });
}


function loadChatList() {
    const container = document.getElementById('friends-chat-list');
    container.innerHTML = '';
    
    database.ref('friends/' + currentUser.uid).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const friends = snapshot.val();
                Object.keys(friends).forEach(friendId => {
                    loadChatFriendInfo(friendId, container);
                });
            } else {
                container.innerHTML = '<p>還沒有好友可以聊天</p>';
            }
        });
}

function loadChatFriendInfo(friendId, container) {
    database.ref('users/' + friendId).once('value')
        .then((snapshot) => {
            const friendData = snapshot.val();
            if (friendData) {
                getUserVtuberAppearance(friendId, (appearance) => {
                    const friendItem = document.createElement('div');
                    friendItem.className = 'friend-item';
                    friendItem.style.cursor = 'pointer';
                    friendItem.onclick = () => openChat(friendId, friendData.characterName || friendData.username);
                    
                    const avatarElement = createVtuberAvatar(appearance, 50);
                    avatarElement.className = 'friend-avatar';
                    avatarElement.style.marginRight = '15px';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'friend-info';
                    infoDiv.innerHTML = `
                        <div><strong>${friendData.characterName || friendData.username || '未命名'}</strong></div>
                        <div>點擊開始聊天</div>
                    `;
                    
                    friendItem.appendChild(avatarElement);
                    friendItem.appendChild(infoDiv);
                    container.appendChild(friendItem);
                });
            }
        });
}

// 獲取用戶的VTUBER外觀信息
function getUserVtuberAppearance(userId, callback) {
    database.ref('users/' + userId + '/vtuberAppearance').once('value')
        .then((snapshot) => {
            const appearanceData = snapshot.val();
            if (appearanceData) {
                callback(appearanceData);
            } else {
                callback({
                    currentExpression: 'default',
                    currentHairstyle: 'default'
                });
            }
        })
        .catch((error) => {
            console.error('獲取VTUBER外觀失敗:', error);
            callback({
                currentExpression: 'default',
                currentHairstyle: 'default'
            });
        });
}

// 創建VTUBER頭像元素
function createVtuberAvatar(appearance, size = 50) {
    const avatarContainer = document.createElement('div');
    avatarContainer.style.cssText = `
        width: ${size}px;
        height: ${size}px;
        border-radius: 50%;
        background: #fde2e4;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--primary);
    `;
    
    const face = document.createElement('div');
    face.style.cssText = `
        width: ${size * 0.8}px;
        height: ${size * 0.8}px;
        border-radius: 50%;
        background: #fde2e4;
        position: relative;
        overflow: hidden;
    `;
    
    // 添加髮型
    const expression = expressions.find(e => e.id === appearance.currentExpression) || expressions[0];
    const hairstyle = hairstyles.find(h => h.id === appearance.currentHairstyle) || hairstyles[0];
    
    if (expression.className) {
        face.classList.add(expression.className);
    }
    
    const hair = document.createElement('div');
    hair.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 60%;
        z-index: 2;
    `;
    if (hairstyle.className) {
        hair.classList.add(hairstyle.className);
    }
    
    // 添加眼睛
    const eyes = document.createElement('div');
    eyes.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: ${size * 0.6}px;
        height: ${size * 0.2}px;
        display: flex;
        justify-content: space-between;
        z-index: 3;
    `;
    
    for (let i = 0; i < 2; i++) {
        const eye = document.createElement('div');
        eye.style.cssText = `
            width: ${size * 0.2}px;
            height: ${size * 0.15}px;
            background: #fff;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        const pupil = document.createElement('div');
        pupil.style.cssText = `
            width: ${size * 0.08}px;
            height: ${size * 0.08}px;
            background: #333;
            border-radius: 50%;
        `;
        
        eye.appendChild(pupil);
        eyes.appendChild(eye);
    }
    
    // 添加嘴巴
    const mouth = document.createElement('div');
    mouth.style.cssText = `
        position: absolute;
        bottom: ${size * 0.2}px;
        left: 50%;
        transform: translateX(-50%);
        width: ${size * 0.25}px;
        height: ${size * 0.1}px;
        background: #ff9aa2;
        border-radius: 0 0 ${size * 0.15}px ${size * 0.15}px;
        z-index: 3;
    `;
    
    face.appendChild(hair);
    face.appendChild(eyes);
    face.appendChild(mouth);
    avatarContainer.appendChild(face);
    
    return avatarContainer;
}


function openChat(friendId, friendName) {
    currentChatFriend = friendId;
    document.getElementById('friends-chat-list').style.display = 'none';
    document.getElementById('chat-window').style.display = 'block';
    document.getElementById('current-friend-name').textContent = friendName;
    
    loadChatMessages();
    
    document.getElementById('back-to-chat-list').onclick = () => {
        document.getElementById('chat-window').style.display = 'none';
        document.getElementById('friends-chat-list').style.display = 'block';
        currentChatFriend = null;
    };
}

function loadChatMessages() {
    const chatId = [currentUser.uid, currentChatFriend].sort().join('_');
    const container = document.getElementById('chat-messages');
    container.innerHTML = '';
    
    // 先設置參與者
    const updates = {};
    updates[`chats/${chatId}/participants/${currentUser.uid}`] = true;
    updates[`chats/${chatId}/participants/${currentChatFriend}`] = true;
    
    database.ref().update(updates).then(() => {
        // 然後監聽消息
        database.ref('chats/' + chatId + '/messages').orderByChild('timestamp').on('value', (snapshot) => {
            container.innerHTML = '';
            if (snapshot.exists()) {
                const messages = snapshot.val();
                Object.values(messages).forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${message.from === currentUser.uid ? 'sent' : 'received'}`;
                    messageDiv.innerHTML = `
                        <div>${message.text}</div>
                        <small>${new Date(message.timestamp).toLocaleString()}</small>
                    `;
                    container.appendChild(messageDiv);
                });
                container.scrollTop = container.scrollHeight;
            }
        });
    }).catch((error) => {
        console.error('設置聊天室參與者失敗:', error);
    });
}

function sendChatMessage() {
    const input = document.getElementById('chat-message-input');
    const message = input.value.trim();
    if (!message || !currentChatFriend) return;
    
    const chatId = [currentUser.uid, currentChatFriend].sort().join('_');
    const messageData = {
        from: currentUser.uid,
        text: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // 同時設置參與者信息以符合安全規則
    const updates = {};
    updates[`chats/${chatId}/messages`] = firebase.database().ref(`chats/${chatId}/messages`).push().key;
    updates[`chats/${chatId}/messages/${updates[`chats/${chatId}/messages`]}`] = messageData;
    updates[`chats/${chatId}/participants/${currentUser.uid}`] = true;
    updates[`chats/${chatId}/participants/${currentChatFriend}`] = true;
    
    database.ref().update(updates)
        .then(() => {
            input.value = '';
        })
        .catch((error) => {
            console.error('發送消息失敗:', error);
        });
}

// 添加Enter鍵發送消息
document.getElementById('chat-message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendChatMessage();
    }
});



function openGiftModal(friendId, friendName) {
    currentGiftReceiver = friendId;
    
    // 創建送禮彈窗
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
    <div class="gift-modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-gift"></i> 送出 ${item.name}</h2>
            <button class="close-modal" onclick="closeGiftModal()">×</button>
        </div>
        <div class="points-display">
            <i class="fas fa-coins"></i>
            <span>我的點數: ${userData.points}</span>
        </div>
        <p>選擇一位好友送出此商品：</p>
        <div id="friend-select-list" style="max-height: 300px; overflow-y: auto;"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="shop-btn buy-btn" id="confirm-gift-btn" disabled>確認送禮</button>
        </div>
    </div>
`;

    
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    
    renderGiftItems();
    loadReceivedGifts();
}

function closeGiftModal() {
    const modal = document.querySelector('.gift-modal');
    if (modal) {
        modal.remove();
    }
    // 重置全局變量
    currentGiftReceiver = null;
    selectedGiftItem = null;
}

// 新增：盲盒送禮專用彈窗
function openMysteryboxGiftModal(mysteryboxItem) {
    currentGiftReceiver = null;
    selectedGiftItem = mysteryboxItem;
    
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
        <div class="gift-modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> 送出 ${mysteryboxItem.name}</h2>
                <button class="close-modal" onclick="closeGiftModal()">×</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>我的點數: ${userData.points}</span>
            </div>
            <p>選擇一位好友送出盲盒，對方領取時將立即進行抽獎：</p>
            <div id="friend-select-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="shop-btn buy-btn" id="confirm-mysterybox-gift-btn" disabled>確認送禮</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    loadFriendsForMysteryboxGift(mysteryboxItem);
}

// 新增：為盲盒送禮載入好友列表
function loadFriendsForMysteryboxGift(mysteryboxItem) {
    const friendList = document.getElementById('friend-select-list');
    
    if (!currentUser) {
        friendList.innerHTML = '<p>請先登入！</p>';
        return;
    }
    
    database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
        if (snapshot.exists()) {
            const friends = snapshot.val();
            const friendPromises = Object.keys(friends).map(friendId => {
                return database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                    return { id: friendId, data: friendSnapshot.val() };
                });
            });
            
            Promise.all(friendPromises).then((friendsData) => {
                friendList.innerHTML = '';
                friendList.style.cssText = `
                    max-height: 400px;
                    overflow-y: auto;
                    padding: 10px 0;
                `;
                
                friendsData.forEach(({ id: friendId, data: friendData }) => {
                    if (friendData) {
                        const friendDiv = document.createElement('div');
                        friendDiv.className = 'friend-item';
                        friendDiv.style.cssText = `
                            display: flex;
                            align-items: center;
                            padding: 15px;
                            margin-bottom: 10px;
                            border: 1px solid #e2e8f0;
                            border-radius: 10px;
                            background: white;
                            transition: all 0.3s ease;
                            justify-content: space-between;
                            min-width: 400px;
                        `;

                        const avatarElement = createVtuberAvatar(
                            friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
                            50
                        );
                        avatarElement.style.marginRight = '15px';

                        const leftSection = document.createElement('div');
                        leftSection.style.cssText = `
                            display: flex;
                            align-items: center;
                            flex: 1;
                            min-width: 0;
                            margin-right: 15px;
                        `;

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'friend-info';
                        infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

                        const selectBtn = document.createElement('button');
                        selectBtn.className = 'shop-btn buy-btn select-mysterybox-friend-btn';
                        selectBtn.setAttribute('data-friend-id', friendId);
                        selectBtn.style.cssText = `
                            background: #4a90e2;
                            padding: 10px 16px;
                            border-radius: 8px;
                            font-size: 0.9rem;
                            min-width: 80px;
                            max-width: 100px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            flex-shrink: 0;
                        `;
                        selectBtn.textContent = '選擇';

                        leftSection.appendChild(avatarElement);
                        leftSection.appendChild(infoDiv);

                        friendDiv.appendChild(leftSection);
                        friendDiv.appendChild(selectBtn);
                        friendList.appendChild(friendDiv);
                    }
                });
                
                bindMysteryboxGiftSelectionEvents(mysteryboxItem);
            });
        } else {
            friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">你還沒有好友可以送禮！</p>';
        }
    }).catch((error) => {
        console.error('載入好友列表失敗:', error);
        friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">載入好友列表失敗，請重試。</p>';
    });
}

// 新增：綁定盲盒送禮選擇事件
function bindMysteryboxGiftSelectionEvents(mysteryboxItem) {
    const selectButtons = document.querySelectorAll('.select-mysterybox-friend-btn');
    const confirmBtn = document.getElementById('confirm-mysterybox-gift-btn');
    
    selectButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const friendId = this.getAttribute('data-friend-id');
            
            currentGiftReceiver = friendId;
            selectedGiftItem = mysteryboxItem;
            
            // 重置所有按鈕狀態
            selectButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#4a90e2';
                btn.textContent = '選擇';
            });
            
            // 設置當前選中按鈕狀態
            this.classList.add('active');
            this.style.background = '#ff6b9d';
            this.textContent = '已選擇';
            
            // 啟用確認按鈕
            confirmBtn.disabled = false;
            confirmBtn.style.background = '#ff6b9d';
            
            // 綁定確認按鈕事件
            confirmBtn.onclick = function() {
                if (currentGiftReceiver && selectedGiftItem) {
                    sendMysteryboxGiftToFriend(selectedGiftItem, currentGiftReceiver);
                } else {
                    alert('送禮信息不完整，請重新選擇！');
                }
            };
        });
    });
}

// 新增：發送盲盒禮物給好友
function sendMysteryboxGiftToFriend(mysteryboxItem, friendId) {
    if (!mysteryboxItem || !friendId) {
        alert('送禮信息不完整，請重新選擇！');
        return;
    }
    
    if (userData.points < mysteryboxItem.price) {
        alert('點數不足！');
        return;
    }
    
    // 扣除點數
    userData.points -= mysteryboxItem.price;
    updatePointsDisplay();
    saveUserData();
    
    // 準備盲盒禮物數據
    const mysteryboxGiftData = {
        from: currentUser.uid,
        fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : '未知用戶',
        boxType: mysteryboxItem.id,
        boxName: mysteryboxItem.name,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // 發送盲盒禮物到 Firebase
    database.ref('mysteryboxGifts').push(mysteryboxGiftData)
        .then((ref) => {
            // 將盲盒禮物ID記錄到接收者的禮物列表
            const giftNotificationData = {
                from: currentUser.uid,
                fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : '未知用戶',
                itemId: ref.key,
                itemType: 'mysteryboxGift',
                itemName: `${mysteryboxItem.name}`,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            return database.ref('users/' + friendId + '/gifts').push(giftNotificationData);
        })
        .then(() => {
            alert(`成功送出 ${mysteryboxItem.name} 給好友！`);
            closeGiftModal();
        })
        .catch((error) => {
            console.error('送禮失敗:', error);
            alert('送禮失敗: ' + error.message);
            // 回滾點數
            userData.points += mysteryboxItem.price;
            updatePointsDisplay();
            saveUserData();
        });
}




function renderGiftItems() {
    const container = document.getElementById('gift-items');
    container.innerHTML = '';
    
    // 只顯示商店中的商品（排除食物，因為食物是消耗品）
    const allItems = [...expressions, ...hairstyles, ...personalities].filter(item => !item.isHidden);
    
    allItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'gift-item';
        itemDiv.onclick = () => selectGiftItem(item, itemDiv);
    console.log('點擊了禮物項目：', item);
        
        let previewContent = '';
        if (expressions.includes(item)) {
            previewContent = '😊';
        } else if (hairstyles.includes(item)) {
            previewContent = '💇';
        } else if (personalities.includes(item)) {
            previewContent = item.icon;
        }
        
        itemDiv.innerHTML = `
            <div style="font-size: 2rem; margin-bottom: 10px;">${previewContent}</div>
            <h4>${item.name}</h4>
            <div class="price">${item.price} 點</div>
        `;
        
        container.appendChild(itemDiv);
    });
}

function openGiftSendModal(item) {
    // 先重置變量
    currentGiftReceiver = null;
    selectedGiftItem = null;
    
    const modal = document.createElement('div');
    modal.className = 'gift-modal';
    modal.innerHTML = `
        <div class="gift-modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-gift"></i> 送出 ${item.name}</h2>
                <button class="close-modal" onclick="closeGiftModal()">×</button>
            </div>
            <div class="points-display">
                <i class="fas fa-coins"></i>
                <span>我的點數: ${userData.points}</span>
            </div>
            <p>選擇一位好友送出此商品：</p>
            <div id="friend-select-list"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="shop-btn buy-btn" id="confirm-gift-btn" disabled>確認送禮</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    // 載入好友列表
    loadFriendsForGift(item);
    
    // 在 openGiftSendModal 函數中，找到並替換好友列表生成部分
const friendList = document.getElementById('friend-select-list');
database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
    if (snapshot.exists()) {
        const friends = snapshot.val();
        Object.keys(friends).forEach(friendId => {
            database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                const friendData = friendSnapshot.val();
                const friendDiv = document.createElement('div');
friendDiv.className = 'friend-item';
friendDiv.style.cssText = `
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
`;

// 創建好友頭像
const avatar = createVtuberAvatar(
    friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
    40
);
avatar.style.marginRight = '12px';

const infoDiv = document.createElement('div');
infoDiv.className = 'friend-info';
infoDiv.style.flex = '1';
infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

const selectBtn = document.createElement('button');
selectBtn.className = 'shop-btn buy-btn select-friend-btn';
selectBtn.setAttribute('data-friend-id', friendId);
selectBtn.style.cssText = `
    background: #4a90e2;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    min-width: 80px;
`;
selectBtn.textContent = '選擇';

friendDiv.appendChild(avatar);
friendDiv.appendChild(infoDiv);
friendDiv.appendChild(selectBtn);

                friendList.appendChild(friendDiv);
            });
        });
        
        // 添加事件監聽器
        setTimeout(() => {
            const selectButtons = friendList.querySelectorAll('.select-friend-btn');
            selectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const friendId = this.getAttribute('data-friend-id');
  
                });
            });
        }, 1000);
        
    } else {
        friendList.innerHTML = '<p>你還沒有好友可以送禮！</p>';
    }
});

function loadFriendsForGift(item) {
    const friendList = document.getElementById('friend-select-list');
    
    if (!currentUser) {
        friendList.innerHTML = '<p>請先登入！</p>';
        return;
    }
    
   database.ref('friends/' + currentUser.uid).once('value').then((snapshot) => {
    if (snapshot.exists()) {
        const friends = snapshot.val();
        const friendPromises = Object.keys(friends).map(friendId => {
            return database.ref('users/' + friendId).once('value').then((friendSnapshot) => {
                return { id: friendId, data: friendSnapshot.val() };
            });
        });
        
        Promise.all(friendPromises).then((friendsData) => {
            const friendList = document.getElementById('friend-select-list');
            friendList.innerHTML = '';
            friendList.style.cssText = `
                max-height: 400px;
                overflow-y: auto;
                padding: 10px 0;
            `;
            
            friendsData.forEach(({ id: friendId, data: friendData }) => {
                if (friendData) {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.style.cssText = `
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    background: white;
    transition: all 0.3s ease;
    justify-content: space-between;
    min-width: 400px; /* 增加容器最小寬度 */
`;


                    const avatarElement = createVtuberAvatar(
                        friendData.vtuberAppearance || { currentExpression: 'default', currentHairstyle: 'default' }, 
                        50
                    );
                    avatarElement.style.marginRight = '15px';

                    const leftSection = document.createElement('div');
                    leftSection.style.cssText = `
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0; /* 允許縮小 */
    margin-right: 15px; /* 增加與按鈕的間距 */
`;


                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'friend-info';
                    infoDiv.innerHTML = `<strong>${friendData.characterName || friendData.email}</strong>`;

                    const selectBtn = document.createElement('button');
                    selectBtn.className = 'shop-btn buy-btn select-friend-btn';
                    selectBtn.setAttribute('data-friend-id', friendId);
                    selectBtn.style.cssText = `
    background: #4a90e2;
    padding: 10px 16px; /* 減少左右內邊距 */
    border-radius: 8px;
    font-size: 0.9rem; /* 稍微減小字體 */
    min-width: 80px; /* 減少按鈕最小寬度 */
    max-width: 100px; /* 限制按鈕最大寬度 */
    font-weight: bold;
    transition: all 0.3s ease;
    flex-shrink: 0; /* 防止按鈕被壓縮 */
`;

                    selectBtn.textContent = '選擇';

                    leftSection.appendChild(avatarElement);
                    leftSection.appendChild(infoDiv);

                    friendDiv.appendChild(leftSection);
                    friendDiv.appendChild(selectBtn);
                    friendList.appendChild(friendDiv);
                }
            });
            
            // 重新綁定事件監聽器
            bindGiftSelectionEvents(item);
        });
    } else {
        const friendList = document.getElementById('friend-select-list');
        friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">你還沒有好友可以送禮！</p>';
    }
}).catch((error) => {
    console.error('載入好友列表失敗:', error);
    const friendList = document.getElementById('friend-select-list');
    friendList.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">載入好友列表失敗，請重試。</p>';
});

}

function bindGiftSelectionEvents(item) {
    const selectButtons = document.querySelectorAll('.select-friend-btn');
    const confirmBtn = document.getElementById('confirm-gift-btn');
    
    selectButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const friendId = this.getAttribute('data-friend-id');
            
            // 設置全局變量
            currentGiftReceiver = friendId;
            selectedGiftItem = item;
            
            // 重置所有按鈕狀態
            selectButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#4a90e2';
                btn.textContent = '選擇';
            });
            
            // 設置當前選中按鈕狀態
            this.classList.add('active');
            this.style.background = '#ff6b9d';
            this.textContent = '已選擇';
            
            // 啟用確認按鈕
            confirmBtn.disabled = false;
            confirmBtn.style.background = '#ff6b9d';
            
            // 綁定確認按鈕事件
            confirmBtn.onclick = function() {
                if (currentGiftReceiver && selectedGiftItem) {
                    sendGiftToFriend(selectedGiftItem, currentGiftReceiver);
                } else {
                    alert('送禮信息不完整，請重新選擇！');
                }
            };
        });
    });
}


    
function selectGiftReceiver(friendId, button, item) {
    console.log('選擇好友:', friendId, '商品:', item);
    currentGiftReceiver = friendId;
    selectedGiftItem = item;
    
    // 重置所有按鈕狀態
    document.querySelectorAll('.select-friend-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#4a90e2';
        btn.textContent = '選擇';
    });
    
    // 設置當前選中按鈕狀態
    button.classList.add('active');
    button.style.background = '#ff6b9d';
    button.textContent = '已選擇';
    
    // 啟用確認按鈕
    const confirmBtn = document.getElementById('confirm-gift-btn');
    confirmBtn.disabled = false;
    confirmBtn.style.background = '#ff6b9d';
    
    // 設置確認按鈕點擊事件
    confirmBtn.onclick = () => {
        sendGiftToFriend(item, friendId);
    };
}


}





function selectGiftItem(item, element) {
    // 移除其他選中狀態
    document.querySelectorAll('.gift-item').forEach(el => el.classList.remove('selected'));
    
    // 選中當前項目
    element.classList.add('selected');
    selectedGiftItem = item;
    
    // 啟用送禮按鈕
    document.getElementById('send-gift-btn').disabled = false;
}

function sendGiftToFriend(item, friendId) {
    if (!item || !friendId) {
        alert('送禮信息不完整，請重新選擇！');
        return;
    }
    
    if (userData.points < item.price) {
        alert('點數不足！');
        return;
    }
    
    // 扣除點數
    userData.points -= item.price;
    updatePointsDisplay();
    saveUserData();
    
    // 準備禮物數據，確保符合Firebase規則
    const giftData = {
        from: currentUser.uid,
        fromName: userProfile ? (userProfile.characterName || userProfile.email.split('@')[0]) : '未知用戶',
        itemId: item.id,
        itemType: getItemTypeForGift(item),
        itemName: item.name,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    // 發送禮物到 Firebase
    database.ref('users/' + friendId + '/gifts').push(giftData)
        .then(() => {
            alert(`成功送出 ${item.name} 給好友！`);
            closeGiftModal();
        })
        .catch((error) => {
            console.error('送禮失敗:', error);
            alert('送禮失敗: ' + error.message);
            // 回滾點數
            userData.points += item.price;
            updatePointsDisplay();
            saveUserData();
        });
}









function getItemTypeForGift(item) {
    // 根據item的id前綴或在哪個數組中來判斷類型
    const expressionItem = expressions.find(e => e.id === item.id);
    if (expressionItem) return 'expression';
    
    const hairstyleItem = hairstyles.find(h => h.id === item.id);
    if (hairstyleItem) return 'hairstyle';
    
    const personalityItem = personalities.find(p => p.id === item.id);
    if (personalityItem) return 'personality';
    
    return 'unknown';
}

function loadReceivedGifts() {
    database.ref('users/' + currentUser.uid + '/gifts').once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const gifts = snapshot.val();
                const container = document.querySelector('.gift-modal-content');
                
                // 創建已收到禮物區域
                const receivedDiv = document.createElement('div');
                receivedDiv.className = 'received-gifts';
                receivedDiv.innerHTML = '<h3><i class="fas fa-gift"></i> 收到的禮物</h3>';
                
                Object.entries(gifts).forEach(([giftId, gift]) => {
                    const giftItem = document.createElement('div');
                    giftItem.className = 'received-gift-item';
                    giftItem.innerHTML = `
                        <div style="margin-right: 15px;">
                            <strong>${gift.itemName}</strong><br>
                            <small>來自: ${gift.fromName}</small>
                        </div>
                        <button class="shop-btn use-btn" onclick="claimGift('${giftId}', '${gift.itemId}', '${gift.itemType}')">
                            領取
                        </button>
                    `;
                    receivedDiv.appendChild(giftItem);
                });
                
                // 插入到點數顯示後面
                const pointsDisplay = container.querySelector('.points-display');
                pointsDisplay.parentNode.insertBefore(receivedDiv, pointsDisplay.nextSibling);
            }
        });
}

function claimGift(giftId, itemId, itemType) {
    // 立即隱藏該禮物項目
    const giftElement = document.querySelector(`[onclick*="${giftId}"]`).closest('.received-gift-item');
    if (giftElement) {
        giftElement.style.display = 'none';
    }
    
    // 處理盲盒禮物
    if (itemType === 'mysteryboxGift') {
        // 從Firebase獲取盲盒禮物數據
        database.ref('mysteryboxGifts/' + itemId).once('value')
            .then((snapshot) => {
                const mysteryboxGiftData = snapshot.val();
                if (mysteryboxGiftData) {
                    // 找到對應的盲盒類型
                    const mysteryboxType = mysteryboxes.find(box => box.id === mysteryboxGiftData.boxType);
                    if (mysteryboxType) {
                        // 立即打開盲盒動畫
                        openMysteryBox(mysteryboxType);
                        
                        // 刪除盲盒禮物數據
                        database.ref('mysteryboxGifts/' + itemId).remove();
                        
                        // 從接收者的禮物列表中刪除
                        database.ref('users/' + currentUser.uid + '/gifts/' + giftId).remove()
                            .then(() => {
                                // 重新渲染禮物列表
                                renderShopItems('gifts');
                            });
                    }
                }
            })
            .catch((error) => {
                console.error('處理盲盒禮物失敗:', error);
                alert('領取失敗: ' + error.message);
                if (giftElement) {
                    giftElement.style.display = 'flex';
                }
            });
        return;
    }
    
    // 原有的普通禮物處理邏輯
    if (itemType === 'expression' && !userData.purchasedExpressions.includes(itemId)) {
        userData.purchasedExpressions.push(itemId);
    } else if (itemType === 'hairstyle' && !userData.purchasedHairstyles.includes(itemId)) {
        userData.purchasedHairstyles.push(itemId);
    } else if (itemType === 'personality' && !userData.purchasedPersonalities.includes(itemId)) {
        userData.purchasedPersonalities.push(itemId);
    }

    // 如果領取的是盲盒，添加免費抽獎次數
    if (itemType === 'mysterybox') {
        if (!userData.freeMysteryboxDraws) {
            userData.freeMysteryboxDraws = {};
        }
        
        // 根據盲盒等級給予免費抽獎次數
        if (itemId === 'bronze') {
            userData.freeMysteryboxDraws.bronze = (userData.freeMysteryboxDraws.bronze || 0) + 1;
        } else if (itemId === 'silver') {
            userData.freeMysteryboxDraws.silver = (userData.freeMysteryboxDraws.silver || 0) + 1;
        } else if (itemId === 'gold') {
            userData.freeMysteryboxDraws.gold = (userData.freeMysteryboxDraws.gold || 0) + 1;
        }
    }
    
    saveUserData();
    
    // 從 Firebase 中刪除該禮物
    database.ref('users/' + currentUser.uid + '/gifts/' + giftId).remove()
        .then(() => {
            alert('禮物領取成功！');
            // 重新渲染禮物列表
            renderShopItems('gifts');
        })
        .catch((error) => {
            console.error('領取禮物失敗:', error);
            alert('領取失敗: ' + error.message);
            // 如果失敗，重新顯示禮物項目
            if (giftElement) {
                giftElement.style.display = 'flex';
            }
        });
}

// 點擊模態框外部關閉 - 更新現有代碼
window.addEventListener('click', (e) => {
    if (e.target === shopModal) {
        shopModal.style.display = 'none';
    }
    if (e.target === settingsModal) {
        settingsModal.style.display = 'none';
    }
    if (e.target === friendsModal) {
        friendsModal.style.display = 'none';
    }
    if (e.target.classList.contains('gift-modal')) {
        closeGiftModal();
    }
    if (e.target === mysteryboxAnimation) {
        // 不允許點擊關閉盲盒動畫
    }
});


    </script>



<!-- 禮物提醒通知 -->
<div class="gift-notification" id="gift-notification" style="display: none;">
    <div class="gift-notification-content">
        <h3>🎁 收到新禮物！</h3>
        <p>你有新的禮物待領取，快去好友系統查看吧！</p>
        <button onclick="closeGiftNotification()">知道了</button>
    </div>
</div>


</body>
</html>
